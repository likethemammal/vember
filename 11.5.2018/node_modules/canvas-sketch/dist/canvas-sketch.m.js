import convertUnits from 'convert-units';
import isDOM from 'is-dom';
import dateformat from 'dateformat';
import assign from 'object-assign';
import padLeft from 'pad-left';
import defined from 'defined';
import getCanvasContext from 'get-canvas-context';
import rightNow from 'right-now';
import isPromise from 'is-promise';
import deepEqual from 'deep-equal';

var defaultUnits = 'mm';
var data = [['postcard',101.6,152.4],['poster-small',280,430],['poster',460,610],
    ['poster-large',610,910],['business-card',50.8,88.9],['a0',841,1189],['a1',594,
    841],['a2',420,594],['a3',297,420],['a4',210,297],['a5',148,210],['a6',105,148],
    ['a7',74,105],['a8',52,74],['a9',37,52],['a10',26,37],['2a0',1189,1682],['4a0',
    1682,2378],['b0',1000,1414],['b1',707,1000],['b1+',720,1020],['b2',500,707],['b2+',
    520,720],['b3',353,500],['b4',250,353],['b5',176,250],['b6',125,176],['b7',88,
    125],['b8',62,88],['b9',44,62],['b10',31,44],['b11',22,32],['b12',16,22],['c0',
    917,1297],['c1',648,917],['c2',458,648],['c3',324,458],['c4',229,324],['c5',162,
    229],['c6',114,162],['c7',81,114],['c8',57,81],['c9',40,57],['c10',28,40],['c11',
    22,32],['c12',16,22],['half-letter',5.5,8.5,'in'],['letter',8.5,11,'in'],['legal',
    8.5,14,'in'],['junior-legal',5,8,'in'],['ledger',11,17,'in'],['tabloid',11,17,
    'in'],['ansi-a',8.5,11.0,'in'],['ansi-b',11.0,17.0,'in'],['ansi-c',17.0,22.0,
    'in'],['ansi-d',22.0,34.0,'in'],['ansi-e',34.0,44.0,'in'],['arch-a',9,12,'in'],
    ['arch-b',12,18,'in'],['arch-c',18,24,'in'],['arch-d',24,36,'in'],['arch-e',36,
    48,'in'],['arch-e1',30,42,'in'],['arch-e2',26,38,'in'],['arch-e3',27,39,'in']];
var paperSizes = data.reduce(function (dict, preset) {
    var item = {
        units: preset[3] || defaultUnits,
        dimensions: [preset[1],preset[2]]
    };
    dict[preset[0]] = item;
    dict[preset[0].replace(/-/g, ' ')] = item;
    return dict;
}, {})

var availableUnits = ['px','m','cm','mm','in','km','ft'];
function roundFractional(n) {
    return parseFloat(n.toFixed(4));
}

function inchesToPixels(inches, pixelsPerInch) {
    if ( pixelsPerInch === void 0 ) pixelsPerInch = 72;

    return Math.round(pixelsPerInch * inches);
}

function getDimensionsFromPreset(dimensions, unitsTo, pixelsPerInch) {
    if ( unitsTo === void 0 ) unitsTo = 'px';
    if ( pixelsPerInch === void 0 ) pixelsPerInch = 72;

    if (typeof dimensions === 'string') {
        var key = dimensions.toLowerCase();
        if (!(key in paperSizes)) {
            throw new Error(("The dimension preset \"" + dimensions + "\" is not supported or could not be found; try using a4, a3, postcard, letter, etc."));
        }
        var preset = paperSizes[key];
        return preset.dimensions.map(function (d) { return convertDistance(d, preset.units, unitsTo, pixelsPerInch); });
    } else {
        return dimensions;
    }
}

function convertDistance(dimension, unitsFrom, unitsTo, pixelsPerInch) {
    if ( unitsFrom === void 0 ) unitsFrom = 'px';
    if ( unitsTo === void 0 ) unitsTo = 'px';
    if ( pixelsPerInch === void 0 ) pixelsPerInch = 72;

    if (unitsFrom === unitsTo) 
        { return dimension; }
    if (unitsTo === 'px') {
        return toPixels(dimension, unitsFrom, pixelsPerInch);
    } else if (unitsFrom === 'px') {
        var inches = dimension * pixelsPerInch;
        return roundFractional(convertUnits(inches).from('in').to(unitsTo));
    }
    if (availableUnits.includes(unitsFrom) && availableUnits.includes(unitsTo)) {
        return roundFractional(convertUnits(dimension).from(unitsFrom).to(unitsTo));
    } else {
        throw new Error("Unsupported unit specified, try one of the following: m, cm, mm, in, ft");
    }
}

function toPixels(dimension, units, pixelsPerInch) {
    if ( pixelsPerInch === void 0 ) pixelsPerInch = 72;

    if (typeof units !== 'string') 
        { throw new Error("Invalid unit type, must be a string like 'cm' or 'in'"); }
    if (units === 'px') 
        { return dimension; }
    if (availableUnits.includes(units)) {
        var inches = convertUnits(dimension).from(units).to('in');
        return inchesToPixels(inches, pixelsPerInch);
    } else {
        throw new Error(("Unsupported unit " + units + ", try one of the following: m, cm, mm, in, ft"));
    }
}

function getClientAPI() {
    return typeof window !== 'undefined' && window['canvas-sketch-cli'];
}

function isWebGLContext(ctx) {
    return typeof ctx.clear === 'function' && typeof ctx.clearColor === 'function' && typeof ctx.bufferData === 'function';
}

function isCanvas(element) {
    return isDOM(element) && /canvas/i.test(element.nodeName) && typeof element.getContext === 'function';
}

var noop = function () {};
var link;
function saveDataURL(dataURI, opts) {
    if ( opts === void 0 ) opts = {};

    return window.fetch(dataURI).then(function (res) { return res.blob(); }).then(function (blob) { return saveBlob(blob, opts); });
}

function saveBlob(blob, opts) {
    if ( opts === void 0 ) opts = {};

    return new Promise(function (resolve) {
        opts = assign({
            extension: '',
            prefix: '',
            suffix: ''
        }, opts);
        var filename = resolveFilename(opts);
        var client = getClientAPI();
        if (client && typeof client.saveBlob === 'function' && client.output) {
            return client.saveBlob(blob, assign({}, opts, {
                filename: filename
            })).then(function (ev) { return resolve(ev); });
        } else {
            if (!link) 
                { link = document.createElement('a'); }
            link.download = filename;
            link.href = window.URL.createObjectURL(blob);
            link.onclick = (function () {
                link.onclick = noop;
                setTimeout(function () {
                    window.URL.revokeObjectURL(blob);
                    link.removeAttribute('href');
                    resolve({
                        filename: filename,
                        client: false
                    });
                });
            });
            link.click();
        }
    });
}

function saveFile(data, opts) {
    if ( opts === void 0 ) opts = {};

    var parts = Array.isArray(data) ? data : [data];
    var blob = new window.Blob(parts, {
        type: opts.type || ''
    });
    return saveBlob(blob, opts);
}

function getFileName() {
    var dateFormatStr = "yyyy.mm.dd-HH.MM.ss";
    return dateformat(new Date(), dateFormatStr);
}

function resolveFilename(opt) {
    if ( opt === void 0 ) opt = {};

    opt = assign({}, opt);
    if (typeof opt.file === 'function') {
        return opt.file(opt);
    } else if (opt.file) {
        return opt.file;
    }
    var frame = null;
    var extension = '';
    if (typeof opt.extension === 'string') 
        { extension = opt.extension; }
    if (typeof opt.frame === 'number') {
        var totalFrames;
        if (typeof opt.totalFrames === 'number') {
            totalFrames = opt.totalFrames;
        } else {
            totalFrames = Math.max(1000, opt.frame);
        }
        frame = padLeft(String(opt.frame), String(totalFrames).length, '0');
    }
    var layerStr = isFinite(opt.totalLayers) && isFinite(opt.layer) && opt.totalLayers > 1 ? ("" + (opt.layer)) : '';
    if (frame != null) {
        return [layerStr,frame].filter(Boolean).join('-') + extension;
    } else {
        var defaultFileName = opt.timeStamp;
        return [opt.prefix,opt.name || defaultFileName,layerStr,opt.hash,opt.suffix].filter(Boolean).join('-') + extension;
    }
}

var isBrowser = function () { return typeof document !== 'undefined'; };
var defaultNodeSize = [300,150];
var SketchManager = function SketchManager() {
    var this$1 = this;

    this._settings = {};
    this._props = {};
    this._sketch = undefined;
    this._raf = null;
    this._lastRedrawResult = undefined;
    this._isP5Resizing = false;
    this._animateHandler = (function () { return this$1.animate(); });
    this._resizeHandler = (function () {
        var oldSizes = this$1._getSizeProps();
        this$1.resize();
        var newSizes = this$1._getSizeProps();
        if (!deepEqual(oldSizes, newSizes)) {
            this$1.render();
        }
    });
    this._exportHandler = (function (ev) {
        if (this$1.settings.hotkeys === false) 
            { return; }
        var client = getClientAPI();
        if (ev.keyCode === 83 && !ev.altKey && (ev.metaKey || ev.ctrlKey)) {
            ev.preventDefault();
            if (ev.shiftKey) {
                if (this$1.props.recording) {
                    this$1.endRecord();
                    this$1.play();
                } else 
                    { this$1.record(); }
            } else 
                { this$1.exportFrame(); }
        } else if (ev.keyCode === 32) {
            if (this$1.props.playing) 
                { this$1.pause(); }
             else 
                { this$1.play(); }
        } else if (client && !ev.altKey && ev.keyCode === 75 && (ev.metaKey || ev.ctrlKey)) {
            ev.preventDefault();
            this$1.exportFrame({
                commit: true
            });
        }
    });
};

var prototypeAccessors = { sketch: { configurable: true },settings: { configurable: true },props: { configurable: true } };
prototypeAccessors.sketch.get = function () {
    return this._sketch;
};
prototypeAccessors.settings.get = function () {
    return this._settings;
};
prototypeAccessors.props.get = function () {
    return this._props;
};
SketchManager.prototype._computePlayhead = function _computePlayhead (currentTime, duration) {
    var hasDuration = typeof duration === 'number' && isFinite(duration);
    return hasDuration ? currentTime / duration : 0;
};
SketchManager.prototype._computeFrame = function _computeFrame (playhead, time, totalFrames, fps) {
    return isFinite(totalFrames) && totalFrames > 1 ? Math.floor(playhead * (totalFrames - 1)) : Math.floor(fps * time);
};
SketchManager.prototype._computeCurrentFrame = function _computeCurrentFrame () {
    return this._computeFrame(this.props.playhead, this.props.time, this.props.totalFrames, this.props.fps);
};
SketchManager.prototype._getSizeProps = function _getSizeProps () {
    var props = this.props;
    return {
        width: props.width,
        height: props.height,
        pixelRatio: props.pixelRatio,
        canvasWidth: props.canvasWidth,
        canvasHeight: props.canvasHeight,
        viewportWidth: props.viewportWidth,
        viewportHeight: props.viewportHeight
    };
};
SketchManager.prototype.run = function run () {
    if (!this.sketch) 
        { throw new Error('should wait until sketch is loaded before trying to play()'); }
    if (this.settings.playing !== false) {
        this.play();
    }
    if (!this.props.started) {
        this._signalBegin();
        this.props.started = true;
    }
    this.tick();
    this.render();
};
SketchManager.prototype.play = function play () {
    var animate = this.settings.animate;
    if ('animation' in this.settings) {
        animate = true;
        console.warn('[canvas-sketch] { animation } has been renamed to { animate }');
    }
    if (!animate) 
        { return; }
    if (!isBrowser()) {
        console.error('[canvas-sketch] WARN: Using { animate } in Node.js is not yet supported');
        return;
    }
    if (!this.props.started) {
        this._signalBegin();
        this.props.started = true;
    }
    this.props.playing = true;
    if (this._raf != null) 
        { window.cancelAnimationFrame(this._raf); }
    this._lastTime = rightNow();
    this._raf = window.requestAnimationFrame(this._animateHandler);
};
SketchManager.prototype.pause = function pause () {
    if (this.props.recording) 
        { this.endRecord(); }
    this.props.playing = false;
    if (this._raf != null && isBrowser()) 
        { window.cancelAnimationFrame(this._raf); }
};
SketchManager.prototype.stop = function stop () {
    this.pause();
    this.props.frame = 0;
    this.props.playhead = 0;
    this.props.time = 0;
    this.props.deltaTime = 0;
    this.props.started = false;
    this.render();
};
SketchManager.prototype.record = function record () {
        var this$1 = this;

    if (this.props.recording) 
        { return; }
    if (!isBrowser()) {
        console.error('[canvas-sketch] WARN: Recording from Node.js is not yet supported');
        return;
    }
    this.stop();
    this.props.playing = true;
    this.props.recording = true;
    var frameInterval = 1 / this.props.fps;
    if (this._raf != null) 
        { window.cancelAnimationFrame(this._raf); }
    var tick = function () {
        if (!this$1.props.recording) 
            { return Promise.resolve(); }
        this$1.props.deltaTime = frameInterval;
        this$1.tick();
        return this$1.exportFrame({
            sequence: true
        }).then(function () {
            if (!this$1.props.recording) 
                { return; }
            this$1.props.deltaTime = 0;
            this$1.props.frame++;
            if (this$1.props.frame < this$1.props.totalFrames) {
                this$1.props.time += frameInterval;
                this$1.props.playhead = this$1._computePlayhead(this$1.props.time, this$1.props.duration);
                this$1._raf = window.requestAnimationFrame(tick);
            } else {
                console.log('Finished recording');
                this$1._signalEnd();
                this$1.endRecord();
                this$1.stop();
                this$1.run();
            }
        });
    };
    if (!this.props.started) {
        this._signalBegin();
        this.props.started = true;
    }
    this._raf = window.requestAnimationFrame(tick);
};
SketchManager.prototype._signalBegin = function _signalBegin () {
        var this$1 = this;

    if (this.sketch && typeof this.sketch.begin === 'function') {
        this._wrapContextScale(function () { return this$1.sketch.begin(this$1.props); });
    }
};
SketchManager.prototype._signalEnd = function _signalEnd () {
        var this$1 = this;

    if (this.sketch && typeof this.sketch.end === 'function') {
        this._wrapContextScale(function () { return this$1.sketch.end(this$1.props); });
    }
};
SketchManager.prototype.endRecord = function endRecord () {
    if (this._raf != null && isBrowser()) 
        { window.cancelAnimationFrame(this._raf); }
    this.props.recording = false;
    this.props.deltaTime = 0;
};
SketchManager.prototype.exportFrame = function exportFrame (opt) {
        var this$1 = this;
        if ( opt === void 0 ) opt = {};

    if (!this.sketch) 
        { return Promise.all([]); }
    if (typeof this.sketch.preExport === 'function') {
        this.sketch.preExport();
    }
    var exportOpts = assign({
        sequence: opt.sequence,
        frame: opt.sequence ? this.props.frame : undefined,
        file: this.settings.file,
        name: this.settings.name,
        prefix: this.settings.prefix,
        suffix: this.settings.suffix,
        timeStamp: getFileName(),
        totalFrames: isFinite(this.props.totalFrames) ? Math.max(100, this.props.totalFrames) : 1000
    });
    var client = getClientAPI();
    var p = Promise.resolve();
    if (client && opt.commit && typeof client.commit === 'function') {
        var commitOpts = assign({}, exportOpts);
        var hash = client.commit(commitOpts);
        if (isPromise(hash)) 
            { p = hash; }
         else 
            { p = Promise.resolve(hash); }
    }
    return p.then(function (hash) { return this$1._doExportFrame(assign({}, exportOpts, {
        hash: hash || ''
    })); });
};
SketchManager.prototype._doExportFrame = function _doExportFrame (exportOpts) {
        var this$1 = this;
        if ( exportOpts === void 0 ) exportOpts = {};

    this._props.exporting = true;
    this.resize();
    var drawResult = this.render();
    var canvas = this.props.canvas;
    if (typeof drawResult === 'undefined') {
        drawResult = [canvas];
    }
    drawResult = [].concat(drawResult).filter(Boolean);
    drawResult = drawResult.map(function (result) {
        var hasDataObject = typeof result === 'object' && result && 'data' in result;
        var data = hasDataObject ? result.data : result;
        var opts = hasDataObject ? assign({}, result, {
            data: data
        }) : {
            data: data
        };
        if (isCanvas(data)) {
            return Object.assign(opts, {
                url: data.toDataURL('image/png'),
                extension: '.png',
                type: 'image/png'
            });
        } else {
            return opts;
        }
    });
    this._props.exporting = false;
    this.resize();
    this.render();
    return Promise.all(drawResult.map(function (result, i, layerList) {
        var curOpt = assign({}, exportOpts, result, {
            layer: i,
            totalLayers: layerList.length
        });
        var data = result.data;
        if (result.url) {
            var url = result.url;
            delete curOpt.url;
            return saveDataURL(url, curOpt);
        } else {
            return saveFile(data, curOpt);
        }
    })).then(function (ev) {
        if (ev.length > 0) {
            var eventWithOutput = ev.find(function (e) { return e.outputName; });
            var isClient = ev.some(function (e) { return e.client; });
            var item;
            if (ev.length > 1) 
                { item = ev.length; }
             else if (eventWithOutput) 
                { item = (eventWithOutput.outputName) + "/" + (ev[0].filename); }
             else 
                { item = "" + (ev[0].filename); }
            var ofSeq = '';
            if (exportOpts.sequence) {
                var hasTotalFrames = isFinite(this$1.props.totalFrames);
                ofSeq = hasTotalFrames ? (" (frame " + (exportOpts.frame + 1) + " / " + (this$1.props.totalFrames) + ")") : (" (frame " + (exportOpts.frame) + ")");
            }
            var client = isClient ? 'canvas-sketch-cli' : 'canvas-sketch';
            console.log(("%c[" + client + "]%c Exported %c" + item + "%c" + ofSeq), 'color: #8e8e8e;', 'color: initial;', 'font-weight: bold;', 'font-weight: initial;');
        }
        if (typeof this$1.sketch.postExport === 'function') {
            this$1.sketch.postExport();
        }
    });
};
SketchManager.prototype._isAutoScale = function _isAutoScale () {
    return !this.props.gl && this.settings.scaleContext !== false;
};
SketchManager.prototype._wrapContextScale = function _wrapContextScale (cb) {
    this._preRender();
    cb();
    this._postRender();
};
SketchManager.prototype._preRender = function _preRender () {
    var props = this.props;
    var autoScale = this._isAutoScale();
    if (autoScale && props.context && !props.p5) {
        props.context.save();
        props.context.scale(props.scaleX, props.scaleY);
    } else if (props.p5) {
        props.p5.scale(props.scaleX / props.pixelRatio, props.scaleY / props.pixelRatio);
    }
};
SketchManager.prototype._postRender = function _postRender () {
    var props = this.props;
    var autoScale = this._isAutoScale();
    if (autoScale && props.context && !props.p5) {
        props.context.restore();
    }
    if (props.gl && this.settings.flush !== false && !props.p5) {
        props.gl.flush();
    }
};
SketchManager.prototype.tick = function tick () {
    if (this.sketch && typeof this.sketch.tick === 'function') {
        this._preRender();
        this.sketch.tick(this.props);
        this._postRender();
    }
};
SketchManager.prototype.render = function render () {
    if (this.props.p5) {
        this._lastRedrawResult = undefined;
        this.props.p5.redraw();
        return this._lastRedrawResult;
    } else {
        return this.submitDrawCall();
    }
};
SketchManager.prototype.submitDrawCall = function submitDrawCall () {
    if (!this.sketch) 
        { return; }
    var props = this.props;
    this._preRender();
    var drawResult;
    if (typeof this.sketch === 'function') {
        drawResult = this.sketch(props);
    } else if (typeof this.sketch.render === 'function') {
        drawResult = this.sketch.render(props);
    }
    this._postRender();
    return drawResult;
};
SketchManager.prototype.update = function update (opt) {
        var this$1 = this;
        if ( opt === void 0 ) opt = {};

    var notYetSupported = ['frame','time','duration','totalFrames','fps','playing',
        'animation'];
    Object.keys(opt).forEach(function (key) {
        if (notYetSupported.indexOf(key) >= 0) {
            throw new Error(("Sorry, the { " + key + " } option is not yet supported with update()."));
        }
    });
    var oldCanvas = this._settings.canvas;
    var oldContext = this._settings.context;
    for (var key in opt) {
        var value = opt[key];
        if (typeof value !== 'undefined') {
            this$1._settings[key] = value;
        }
    }
    if (oldCanvas !== this._settings.canvas || oldContext !== this._settings.context) {
        var ref = this._setupCanvas(this._settings);
            var canvas = ref.canvas;
            var context = ref.context;
        this.props.canvas = canvas;
        this.props.context = context;
        this._setupGLKey();
        this._appendCanvasIfNeeded();
    }
    if (opt.p5 && typeof opt.p5 !== 'function') {
        this.props.p5 = opt.p5;
        this.props.p5.draw = (function () {
            if (this$1._isP5Resizing) 
                { return; }
            this$1._lastRedrawResult = this$1.submitDrawCall();
        });
    }
    this.resize();
    this.render();
    return this.props;
};
SketchManager.prototype._hasDimensions = function _hasDimensions () {
    var settings = this.settings;
    if (!settings.dimensions) 
        { return false; }
    if (typeof settings.dimensions === 'string') 
        { return true; }
    if (Array.isArray(settings.dimensions) && settings.dimensions.length >= 2) 
        { return true; }
    return false;
};
SketchManager.prototype.resize = function resize () {
    var width, height;
    var styleWidth, styleHeight;
    var canvasWidth, canvasHeight;
    var settings = this.settings;
    var dimensions = settings.dimensions;
    var hasDimensions = this._hasDimensions();
    var exporting = this.props.exporting;
    var scaleToFit = hasDimensions ? settings.scaleToFit !== false : false;
    var scaleToView = !exporting && hasDimensions ? settings.scaleToView : true;
    var units = settings.units;
    var pixelsPerInch = typeof settings.pixelsPerInch === 'number' && isFinite(settings.pixelsPerInch) ? settings.pixelsPerInch : 72;
    var bleed = defined(settings.bleed, 0);
    var defaultPixelRatio = isBrowser() ? window.devicePixelRatio : 1;
    var pixelRatio = defined(settings.pixelRatio, defaultPixelRatio);
    if (typeof settings.maxPixelRatio === 'number') {
        pixelRatio = Math.min(settings.maxPixelRatio, pixelRatio);
    }
    if (!scaleToView) {
        pixelRatio = 1;
    }
    var defaultWidth = isBrowser() ? window.innerWidth : defaultNodeSize[0];
    var defaultHeight = isBrowser() ? window.innerHeight : defaultNodeSize[1];
    var parentWidth = defaultWidth;
    var parentHeight = defaultHeight;
    var trimWidth, trimHeight;
    if (hasDimensions) {
        var result = getDimensionsFromPreset(dimensions, units, pixelsPerInch);
        var highest = Math.max(result[0], result[1]);
        var lowest = Math.min(result[0], result[1]);
        if (settings.orientation) {
            var landscape = settings.orientation === 'landscape';
            width = landscape ? highest : lowest;
            height = landscape ? lowest : highest;
        } else {
            width = result[0];
            height = result[1];
        }
        trimWidth = width;
        trimHeight = height;
        width += bleed * 2;
        height += bleed * 2;
    } else {
        width = parentWidth;
        height = parentHeight;
        trimWidth = width;
        trimHeight = height;
    }
    var realWidth = width;
    var realHeight = height;
    if (hasDimensions && units) {
        realWidth = convertDistance(width, units, 'px', pixelsPerInch);
        realHeight = convertDistance(height, units, 'px', pixelsPerInch);
    }
    styleWidth = Math.round(realWidth);
    styleHeight = Math.round(realHeight);
    if (scaleToFit && !exporting && hasDimensions) {
        var aspect = width / height;
        var windowAspect = parentWidth / parentHeight;
        var scaleToFitPadding = defined(settings.scaleToFitPadding, 40);
        var maxWidth = Math.round(parentWidth - scaleToFitPadding * 2);
        var maxHeight = Math.round(parentHeight - scaleToFitPadding * 2);
        if (styleWidth > maxWidth || styleHeight > maxHeight) {
            if (windowAspect > aspect) {
                styleHeight = maxHeight;
                styleWidth = Math.round(styleHeight * aspect);
            } else {
                styleWidth = maxWidth;
                styleHeight = Math.round(styleWidth / aspect);
            }
        }
    }
    var exportPixelRatio = 1;
    if (exporting) {
        exportPixelRatio = defined(settings.exportPixelRatio, hasDimensions ? 1 : pixelRatio);
        pixelRatio = exportPixelRatio;
    }
    canvasWidth = scaleToView ? Math.round(pixelRatio * styleWidth) : Math.round(exportPixelRatio * realWidth);
    canvasHeight = scaleToView ? Math.round(pixelRatio * styleHeight) : Math.round(exportPixelRatio * realHeight);
    var viewportWidth = scaleToView ? Math.round(styleWidth) : Math.round(realWidth);
    var viewportHeight = scaleToView ? Math.round(styleHeight) : Math.round(realHeight);
    var scaleX = canvasWidth / width;
    var scaleY = canvasHeight / height;
    Object.assign(this._props, {
        bleed: bleed,
        pixelRatio: pixelRatio,
        width: width,
        height: height,
        scaleX: scaleX,
        scaleY: scaleY,
        viewportWidth: viewportWidth,
        viewportHeight: viewportHeight,
        canvasWidth: canvasWidth,
        canvasHeight: canvasHeight,
        trimWidth: trimWidth,
        trimHeight: trimHeight,
        styleWidth: styleWidth,
        styleHeight: styleHeight
    });
    var canvas = this.props.canvas;
    if (canvas && settings.resizeCanvas !== false) {
        if (this.props.p5) {
            if (canvas.width !== canvasWidth || canvas.height !== canvasHeight) {
                this._isP5Resizing = true;
                this.props.p5.pixelDensity(pixelRatio);
                this.props.p5.resizeCanvas(canvasWidth / pixelRatio, canvasHeight / pixelRatio, false);
                this._isP5Resizing = false;
            }
        } else {
            if (canvas.width !== canvasWidth) 
                { canvas.width = canvasWidth; }
            if (canvas.height !== canvasHeight) 
                { canvas.height = canvasHeight; }
        }
        if (isBrowser()) {
            canvas.style.width = styleWidth + "px";
            canvas.style.height = styleHeight + "px";
        }
    }
    if (this.sketch && typeof this.sketch.resize === 'function') {
        this.sketch.resize(this.props);
    }
};
SketchManager.prototype.animate = function animate () {
    if (!this.props.playing) 
        { return; }
    if (!isBrowser()) {
        console.error('[canvas-sketch] WARN: Animation in Node.js is not yet supported');
        return;
    }
    this._raf = window.requestAnimationFrame(this._animateHandler);
    var now = rightNow();
    var fps = this.props.fps;
    var frameIntervalMS = 1000 / fps;
    var deltaTimeMS = now - this._lastTime;
    var duration = this.props.duration;
    var hasDuration = typeof duration === 'number' && isFinite(duration);
    var isNewFrame = true;
    var playbackRate = this.settings.playbackRate;
    if (playbackRate === 'fixed') {
        deltaTimeMS = frameIntervalMS;
    } else if (playbackRate === 'throttle') {
        if (deltaTimeMS > frameIntervalMS) {
            now = now - deltaTimeMS % frameIntervalMS;
            this._lastTime = now;
        } else {
            isNewFrame = false;
        }
    } else {
        this._lastTime = now;
    }
    var deltaTime = deltaTimeMS / 1000;
    var newTime = this.props.time + deltaTime * this.props.timeScale;
    if (newTime < 0 && hasDuration) {
        newTime = duration + newTime;
    }
    var isFinished = false;
    var isLoopStart = false;
    var looping = this.settings.loop !== false;
    if (hasDuration && newTime >= duration) {
        if (looping) {
            isNewFrame = true;
            newTime = newTime % duration;
            isLoopStart = true;
        } else {
            isNewFrame = false;
            newTime = duration;
            isFinished = true;
        }
        this._signalEnd();
    }
    if (isNewFrame) {
        this.props.deltaTime = deltaTime;
        this.props.time = newTime;
        this.props.playhead = this._computePlayhead(newTime, duration);
        var lastFrame = this.props.frame;
        this.props.frame = this._computeCurrentFrame();
        if (isLoopStart) 
            { this._signalBegin(); }
        if (lastFrame !== this.props.frame) 
            { this.tick(); }
        this.render();
        this.props.deltaTime = 0;
    }
    if (isFinished) {
        this.pause();
    }
};
SketchManager.prototype.mount = function mount () {
    this._appendCanvasIfNeeded();
};
SketchManager.prototype.unmount = function unmount () {
    if (isBrowser()) {
        window.removeEventListener('resize', this._resizeHandler);
        window.removeEventListener('keydown', this._exportHandler);
    }
};
SketchManager.prototype._appendCanvasIfNeeded = function _appendCanvasIfNeeded () {
    if (!isBrowser()) 
        { return; }
    if (this.props.canvas && !this.props.canvas.parentElement) {
        var defaultParent = document.body;
        defaultParent.appendChild(this.props.canvas);
    }
};
SketchManager.prototype._createCanvas = function _createCanvas () {
    if (!isBrowser()) {
        throw new Error('It appears you are runing from Node.js or a non-browser environment. Try passing in an existing { canvas } interface instead.');
    }
    return document.createElement('canvas');
};
SketchManager.prototype._setupCanvas = function _setupCanvas (settings) {
    var context, canvas;
    if (settings.canvas !== false) {
        context = settings.context;
        if (!context || typeof context === 'string') {
            var newCanvas = settings.canvas || this._createCanvas();
            var type = context || '2d';
            context = getCanvasContext(type, assign({}, settings.attributes, {
                canvas: newCanvas
            }));
            if (!context) {
                throw new Error(("Failed at canvas.getContext('" + type + "') - the browser may not support this context, or a different context may already be in use with this canvas."));
            }
        }
        canvas = context.canvas;
        if (settings.canvas && canvas !== settings.canvas) {
            throw new Error('The { canvas } and { context } settings must point to the same underlying canvas element');
        }
        if (settings.pixelated) {
            context.imageSmoothingEnabled = false;
            context.mozImageSmoothingEnabled = false;
            context.oImageSmoothingEnabled = false;
            context.webkitImageSmoothingEnabled = false;
            context.msImageSmoothingEnabled = false;
            canvas.style['image-rendering'] = 'pixelated';
        }
    }
    return {
        canvas: canvas,
        context: context
    };
};
SketchManager.prototype._setupGLKey = function _setupGLKey () {
    if (this.props.context) {
        if (isWebGLContext(this.props.context)) {
            this._props.gl = this.props.context;
        } else {
            delete this._props.gl;
        }
    }
};
SketchManager.prototype.setup = function setup (settings) {
        var this$1 = this;
        if ( settings === void 0 ) settings = {};

    if (this.sketch) 
        { throw new Error('Multiple setup() calls not yet supported.'); }
    this._settings = Object.assign({}, settings, this._settings);
    var ref = this._setupCanvas(this._settings);
        var context = ref.context;
        var canvas = ref.canvas;
    var duration = settings.duration;
    var totalFrames = settings.totalFrames;
    var timeScale = defined(settings.timeScale, 1);
    var fps = defined(settings.fps, 30);
    var hasDuration = typeof duration === 'number' && isFinite(duration);
    var hasTotalFrames = typeof totalFrames === 'number' && isFinite(totalFrames);
    var totalFramesFromDuration = hasDuration ? Math.floor(fps * duration) : undefined;
    var durationFromTotalFrames = hasTotalFrames ? totalFrames / fps : undefined;
    if (hasDuration && hasTotalFrames && totalFramesFromDuration !== totalFrames) {
        throw new Error('You should specify either duration or totalFrames, but not both. Or, they must match exactly.');
    }
    totalFrames = defined(totalFrames, totalFramesFromDuration, Infinity);
    duration = defined(duration, durationFromTotalFrames, Infinity);
    var startTime = settings.time;
    var startFrame = settings.frame;
    var hasStartTime = typeof startTime === 'number' && isFinite(startTime);
    var hasStartFrame = typeof startFrame === 'number' && isFinite(startFrame);
    var time = 0;
    var frame = 0;
    var playhead = 0;
    if (hasStartTime && hasStartFrame) {
        throw new Error('You should specify either start frame or time, but not both.');
    } else if (hasStartTime) {
        time = startTime;
        playhead = this._computePlayhead(time, duration);
        frame = this._computeFrame(playhead, time, totalFrames, fps);
    } else if (hasStartFrame) {
        frame = startFrame;
        time = frame / fps;
        playhead = this._computePlayhead(time, duration);
    }
    this._props = {
        canvas: canvas,
        context: context,
        fps: fps,
        frame: frame,
        time: time,
        deltaTime: 0,
        playhead: playhead,
        duration: duration,
        started: false,
        exporting: false,
        playing: false,
        recording: false,
        totalFrames: totalFrames,
        timeScale: timeScale,
        settings: this.settings,
        render: function () { return this$1.render(); },
        tick: function () { return this$1.tick(); },
        resize: function () { return this$1.resize(); },
        update: function (opt) { return this$1.update(opt); },
        exportFrame: function (opt) { return this$1.exportFrame(opt); },
        record: function () { return this$1.record(); },
        play: function () { return this$1.play(); },
        pause: function () { return this$1.pause(); },
        stop: function () { return this$1.stop(); }
    };
    this._setupGLKey();
    this.resize();
};
SketchManager.prototype.load = function load (createSketch) {
        var this$1 = this;

    if (typeof createSketch !== 'function') {
        throw new Error('The function must take in a function as the first parameter. Example:\n  canvasSketcher(() => { ... }, settings)');
    }
    this._preRender();
    var preload = Promise.resolve();
    if (this.settings.p5) {
        if (!isBrowser()) {
            throw new Error('[canvas-sketch] ERROR: Using p5.js in Node.js is not supported');
        }
        preload = new Promise(function (resolve) {
            var P5Constructor = this$1.settings.p5;
            var preload;
            if (P5Constructor.p5) {
                preload = P5Constructor.preload;
                P5Constructor = P5Constructor.p5;
            }
            var p5Sketch = function (p5) {
                if (preload) 
                    { p5.preload = (function () { return preload(p5); }); }
                p5.setup = (function () {
                    var props = this$1.props;
                    var isGL = this$1.settings.context === 'webgl';
                    var renderer = isGL ? p5.WEBGL : p5.P2D;
                    p5.noLoop();
                    p5.pixelDensity(props.pixelRatio);
                    p5.createCanvas(props.viewportWidth, props.viewportHeight, renderer);
                    if (isGL && this$1.settings.attributes) {
                        p5.setAttributes(this$1.settings.attributes);
                    }
                    this$1.update({
                        p5: p5,
                        canvas: p5.canvas,
                        context: p5._renderer.drawingContext
                    });
                    resolve();
                });
            };
            if (typeof P5Constructor === 'function') {
                new P5Constructor(p5Sketch);
            } else {
                if (typeof window.createCanvas !== 'function') {
                    throw new Error("{ p5 } setting is passed but can't find p5.js in global (window) scope. Maybe you did not create it globally?\nnew p5(); // <-- attaches to global scope");
                }
                p5Sketch(window);
            }
        });
    }
    return preload.then(function () {
        var loader = createSketch(this$1.props);
        if (!isPromise(loader)) {
            loader = Promise.resolve(loader);
        }
        return loader;
    }).then(function (sketch) {
        if (!sketch) 
            { sketch = {}; }
        this$1._sketch = sketch;
        if (isBrowser()) {
            window.addEventListener('keydown', this$1._exportHandler);
            window.addEventListener('resize', this$1._resizeHandler);
        }
        this$1._postRender();
        if (typeof this$1._sketch.resize === 'function') {
            this$1.sketch.resize(this$1.props);
        }
    }).catch(function (err) {
        console.warn('Could not start sketch, the async loading function rejected with an error:\n    Error: ' + err.message);
        throw err;
    });
};

Object.defineProperties( SketchManager.prototype, prototypeAccessors );
function canvasSketch(sketch, settings) {
    if ( settings === void 0 ) settings = {};

    if (settings.p5) {
        if (settings.canvas || settings.context && typeof settings.context !== 'string') {
            throw new Error("In { p5 } mode, you can't pass your own canvas or context, unless the context is a \"webgl\" or \"2d\" string");
        }
        var context = typeof settings.context === 'string' ? settings.context : false;
        settings = Object.assign({}, settings, {
            canvas: false,
            context: context
        });
    }
    var manager = new SketchManager();
    if (sketch) {
        manager.setup(settings);
        manager.mount();
        return manager.load(sketch).then(function () {
            manager.run();
            return manager;
        });
    }
    return Promise.resolve(manager);
}

export default canvasSketch;
export { paperSizes as PaperSize };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLXNrZXRjaC5tLmpzIiwic291cmNlcyI6WyIuLi9saWIvcGFwZXItc2l6ZXMuanMiLCIuLi9saWIvZGlzdGFuY2VzLmpzIiwiLi4vbGliL3V0aWwuanMiLCIuLi9saWIvc2F2ZS5qcyIsIi4uL2xpYi9jYW52YXMtc2tldGNoLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGRlZmF1bHRVbml0cyA9ICdtbSc7XG5cbmNvbnN0IGRhdGEgPSBbXG4gIC8vIENvbW1vbiBQYXBlciBTaXplc1xuICAvLyAoTW9zdGx5IE5vcnRoLUFtZXJpY2FuIGJhc2VkKVxuICBbICdwb3N0Y2FyZCcsIDEwMS42LCAxNTIuNCBdLFxuICBbICdwb3N0ZXItc21hbGwnLCAyODAsIDQzMCBdLFxuICBbICdwb3N0ZXInLCA0NjAsIDYxMCBdLFxuICBbICdwb3N0ZXItbGFyZ2UnLCA2MTAsIDkxMCBdLFxuICBbICdidXNpbmVzcy1jYXJkJywgNTAuOCwgODguOSBdLFxuXG4gIC8vIFN0YW5kYXJkIFBhcGVyIFNpemVzXG4gIFsgJ2EwJywgODQxLCAxMTg5IF0sXG4gIFsgJ2ExJywgNTk0LCA4NDEgXSxcbiAgWyAnYTInLCA0MjAsIDU5NCBdLFxuICBbICdhMycsIDI5NywgNDIwIF0sXG4gIFsgJ2E0JywgMjEwLCAyOTcgXSxcbiAgWyAnYTUnLCAxNDgsIDIxMCBdLFxuICBbICdhNicsIDEwNSwgMTQ4IF0sXG4gIFsgJ2E3JywgNzQsIDEwNSBdLFxuICBbICdhOCcsIDUyLCA3NCBdLFxuICBbICdhOScsIDM3LCA1MiBdLFxuICBbICdhMTAnLCAyNiwgMzcgXSxcbiAgWyAnMmEwJywgMTE4OSwgMTY4MiBdLFxuICBbICc0YTAnLCAxNjgyLCAyMzc4IF0sXG4gIFsgJ2IwJywgMTAwMCwgMTQxNCBdLFxuICBbICdiMScsIDcwNywgMTAwMCBdLFxuICBbICdiMSsnLCA3MjAsIDEwMjAgXSxcbiAgWyAnYjInLCA1MDAsIDcwNyBdLFxuICBbICdiMisnLCA1MjAsIDcyMCBdLFxuICBbICdiMycsIDM1MywgNTAwIF0sXG4gIFsgJ2I0JywgMjUwLCAzNTMgXSxcbiAgWyAnYjUnLCAxNzYsIDI1MCBdLFxuICBbICdiNicsIDEyNSwgMTc2IF0sXG4gIFsgJ2I3JywgODgsIDEyNSBdLFxuICBbICdiOCcsIDYyLCA4OCBdLFxuICBbICdiOScsIDQ0LCA2MiBdLFxuICBbICdiMTAnLCAzMSwgNDQgXSxcbiAgWyAnYjExJywgMjIsIDMyIF0sXG4gIFsgJ2IxMicsIDE2LCAyMiBdLFxuICBbICdjMCcsIDkxNywgMTI5NyBdLFxuICBbICdjMScsIDY0OCwgOTE3IF0sXG4gIFsgJ2MyJywgNDU4LCA2NDggXSxcbiAgWyAnYzMnLCAzMjQsIDQ1OCBdLFxuICBbICdjNCcsIDIyOSwgMzI0IF0sXG4gIFsgJ2M1JywgMTYyLCAyMjkgXSxcbiAgWyAnYzYnLCAxMTQsIDE2MiBdLFxuICBbICdjNycsIDgxLCAxMTQgXSxcbiAgWyAnYzgnLCA1NywgODEgXSxcbiAgWyAnYzknLCA0MCwgNTcgXSxcbiAgWyAnYzEwJywgMjgsIDQwIF0sXG4gIFsgJ2MxMScsIDIyLCAzMiBdLFxuICBbICdjMTInLCAxNiwgMjIgXSxcblxuICAvLyBVc2UgaW5jaGVzIGZvciBOb3J0aCBBbWVyaWNhbiBzaXplcyxcbiAgLy8gYXMgaXQgcHJvZHVjZXMgbGVzcyBmbG9hdCBwcmVjaXNpb24gZXJyb3JzXG4gIFsgJ2hhbGYtbGV0dGVyJywgNS41LCA4LjUsICdpbicgXSxcbiAgWyAnbGV0dGVyJywgOC41LCAxMSwgJ2luJyBdLFxuICBbICdsZWdhbCcsIDguNSwgMTQsICdpbicgXSxcbiAgWyAnanVuaW9yLWxlZ2FsJywgNSwgOCwgJ2luJyBdLFxuICBbICdsZWRnZXInLCAxMSwgMTcsICdpbicgXSxcbiAgWyAndGFibG9pZCcsIDExLCAxNywgJ2luJyBdLFxuICBbICdhbnNpLWEnLCA4LjUsIDExLjAsICdpbicgXSxcbiAgWyAnYW5zaS1iJywgMTEuMCwgMTcuMCwgJ2luJyBdLFxuICBbICdhbnNpLWMnLCAxNy4wLCAyMi4wLCAnaW4nIF0sXG4gIFsgJ2Fuc2ktZCcsIDIyLjAsIDM0LjAsICdpbicgXSxcbiAgWyAnYW5zaS1lJywgMzQuMCwgNDQuMCwgJ2luJyBdLFxuICBbICdhcmNoLWEnLCA5LCAxMiwgJ2luJyBdLFxuICBbICdhcmNoLWInLCAxMiwgMTgsICdpbicgXSxcbiAgWyAnYXJjaC1jJywgMTgsIDI0LCAnaW4nIF0sXG4gIFsgJ2FyY2gtZCcsIDI0LCAzNiwgJ2luJyBdLFxuICBbICdhcmNoLWUnLCAzNiwgNDgsICdpbicgXSxcbiAgWyAnYXJjaC1lMScsIDMwLCA0MiwgJ2luJyBdLFxuICBbICdhcmNoLWUyJywgMjYsIDM4LCAnaW4nIF0sXG4gIFsgJ2FyY2gtZTMnLCAyNywgMzksICdpbicgXVxuXTtcblxuZXhwb3J0IGRlZmF1bHQgZGF0YS5yZWR1Y2UoKGRpY3QsIHByZXNldCkgPT4ge1xuICBjb25zdCBpdGVtID0ge1xuICAgIHVuaXRzOiBwcmVzZXRbM10gfHwgZGVmYXVsdFVuaXRzLFxuICAgIGRpbWVuc2lvbnM6IFsgcHJlc2V0WzFdLCBwcmVzZXRbMl0gXVxuICB9O1xuICBkaWN0W3ByZXNldFswXV0gPSBpdGVtO1xuICBkaWN0W3ByZXNldFswXS5yZXBsYWNlKC8tL2csICcgJyldID0gaXRlbTtcbiAgcmV0dXJuIGRpY3Q7XG59LCB7fSk7XG4iLCJpbXBvcnQgY29udmVydFVuaXRzIGZyb20gJ2NvbnZlcnQtdW5pdHMnO1xuaW1wb3J0IHBhcGVyU2l6ZXMgZnJvbSAnLi9wYXBlci1zaXplcyc7XG5cbmNvbnN0IGF2YWlsYWJsZVVuaXRzID0gWyAncHgnLCAnbScsICdjbScsICdtbScsICdpbicsICdrbScsICdmdCcgXTtcblxuZnVuY3Rpb24gcm91bmRGcmFjdGlvbmFsIChuKSB7XG4gIHJldHVybiBwYXJzZUZsb2F0KG4udG9GaXhlZCg0KSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpbmNoZXNUb1BpeGVscyAoaW5jaGVzLCBwaXhlbHNQZXJJbmNoID0gNzIpIHtcbiAgcmV0dXJuIE1hdGgucm91bmQocGl4ZWxzUGVySW5jaCAqIGluY2hlcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXREaW1lbnNpb25zRnJvbVByZXNldCAoZGltZW5zaW9ucywgdW5pdHNUbyA9ICdweCcsIHBpeGVsc1BlckluY2ggPSA3Mikge1xuICBpZiAodHlwZW9mIGRpbWVuc2lvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgY29uc3Qga2V5ID0gZGltZW5zaW9ucy50b0xvd2VyQ2FzZSgpO1xuICAgIGlmICghKGtleSBpbiBwYXBlclNpemVzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZGltZW5zaW9uIHByZXNldCBcIiR7ZGltZW5zaW9uc31cIiBpcyBub3Qgc3VwcG9ydGVkIG9yIGNvdWxkIG5vdCBiZSBmb3VuZDsgdHJ5IHVzaW5nIGE0LCBhMywgcG9zdGNhcmQsIGxldHRlciwgZXRjLmApXG4gICAgfVxuICAgIGNvbnN0IHByZXNldCA9IHBhcGVyU2l6ZXNba2V5XTtcbiAgICByZXR1cm4gcHJlc2V0LmRpbWVuc2lvbnMubWFwKGQgPT4ge1xuICAgICAgcmV0dXJuIGNvbnZlcnREaXN0YW5jZShkLCBwcmVzZXQudW5pdHMsIHVuaXRzVG8sIHBpeGVsc1BlckluY2gpO1xuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBkaW1lbnNpb25zO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb252ZXJ0RGlzdGFuY2UgKGRpbWVuc2lvbiwgdW5pdHNGcm9tID0gJ3B4JywgdW5pdHNUbyA9ICdweCcsIHBpeGVsc1BlckluY2ggPSA3Mikge1xuICBpZiAodW5pdHNGcm9tID09PSB1bml0c1RvKSByZXR1cm4gZGltZW5zaW9uO1xuXG4gIGlmICh1bml0c1RvID09PSAncHgnKSB7XG4gICAgLy8gQ29udmVydGluZyBkaXN0YW5jZSB0byBwaXhlbHMuLi5cbiAgICByZXR1cm4gdG9QaXhlbHMoZGltZW5zaW9uLCB1bml0c0Zyb20sIHBpeGVsc1BlckluY2gpO1xuICB9IGVsc2UgaWYgKHVuaXRzRnJvbSA9PT0gJ3B4Jykge1xuICAgIC8vIENvbnZlcnRpbmcgcGl4ZWxzIHRvIGRpc3RhbmNlLi4uXG4gICAgY29uc3QgaW5jaGVzID0gZGltZW5zaW9uICogcGl4ZWxzUGVySW5jaDtcbiAgICByZXR1cm4gcm91bmRGcmFjdGlvbmFsKGNvbnZlcnRVbml0cyhpbmNoZXMpLmZyb20oJ2luJykudG8odW5pdHNUbykpO1xuICB9XG5cbiAgLy8gQ29udmVydGluZyBmcm9tIG1lYXN1cmVtZW50IHRvIGFub3RoZXIgbWVhc3VyZW1lbnRcbiAgaWYgKGF2YWlsYWJsZVVuaXRzLmluY2x1ZGVzKHVuaXRzRnJvbSkgJiYgYXZhaWxhYmxlVW5pdHMuaW5jbHVkZXModW5pdHNUbykpIHtcbiAgICByZXR1cm4gcm91bmRGcmFjdGlvbmFsKGNvbnZlcnRVbml0cyhkaW1lbnNpb24pLmZyb20odW5pdHNGcm9tKS50byh1bml0c1RvKSk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCB1bml0IHNwZWNpZmllZCwgdHJ5IG9uZSBvZiB0aGUgZm9sbG93aW5nOiBtLCBjbSwgbW0sIGluLCBmdGApO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b1BpeGVscyAoZGltZW5zaW9uLCB1bml0cywgcGl4ZWxzUGVySW5jaCA9IDcyKSB7XG4gIGlmICh0eXBlb2YgdW5pdHMgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIHVuaXQgdHlwZSwgbXVzdCBiZSBhIHN0cmluZyBsaWtlICdjbScgb3IgJ2luJ1wiKTtcbiAgaWYgKHVuaXRzID09PSAncHgnKSByZXR1cm4gZGltZW5zaW9uO1xuICBpZiAoYXZhaWxhYmxlVW5pdHMuaW5jbHVkZXModW5pdHMpKSB7XG4gICAgY29uc3QgaW5jaGVzID0gY29udmVydFVuaXRzKGRpbWVuc2lvbikuZnJvbSh1bml0cykudG8oJ2luJyk7XG4gICAgcmV0dXJuIGluY2hlc1RvUGl4ZWxzKGluY2hlcywgcGl4ZWxzUGVySW5jaCk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCB1bml0ICR7dW5pdHN9LCB0cnkgb25lIG9mIHRoZSBmb2xsb3dpbmc6IG0sIGNtLCBtbSwgaW4sIGZ0YCk7XG4gIH1cbn1cbiIsIi8vIFRPRE86IFdlIGNhbiByZW1vdmUgYSBodWdlIGNodW5rIG9mIGJ1bmRsZSBzaXplIGJ5IHVzaW5nIGEgc21hbGxlclxuLy8gdXRpbGl0eSBtb2R1bGUgZm9yIGNvbnZlcnRpbmcgdW5pdHMuXG5pbXBvcnQgaXNET00gZnJvbSAnaXMtZG9tJztcblxuZXhwb3J0IGZ1bmN0aW9uIGdldENsaWVudEFQSSAoKSB7XG4gIHJldHVybiB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3dbJ2NhbnZhcy1za2V0Y2gtY2xpJ107XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1dlYkdMQ29udGV4dCAoY3R4KSB7XG4gIHJldHVybiB0eXBlb2YgY3R4LmNsZWFyID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBjdHguY2xlYXJDb2xvciA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgY3R4LmJ1ZmZlckRhdGEgPT09ICdmdW5jdGlvbic7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0NhbnZhcyAoZWxlbWVudCkge1xuICByZXR1cm4gaXNET00oZWxlbWVudCkgJiYgL2NhbnZhcy9pLnRlc3QoZWxlbWVudC5ub2RlTmFtZSkgJiYgdHlwZW9mIGVsZW1lbnQuZ2V0Q29udGV4dCA9PT0gJ2Z1bmN0aW9uJztcbn1cbiIsImltcG9ydCBkYXRlZm9ybWF0IGZyb20gJ2RhdGVmb3JtYXQnO1xuaW1wb3J0IGFzc2lnbiBmcm9tICdvYmplY3QtYXNzaWduJztcbmltcG9ydCBwYWRMZWZ0IGZyb20gJ3BhZC1sZWZ0JztcbmltcG9ydCB7IGdldENsaWVudEFQSSB9IGZyb20gJy4vdXRpbCc7XG5cbmNvbnN0IG5vb3AgPSAoKSA9PiB7fTtcbmxldCBsaW5rO1xuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZURhdGFVUkwgKGRhdGFVUkksIG9wdHMgPSB7fSkge1xuICByZXR1cm4gd2luZG93LmZldGNoKGRhdGFVUkkpXG4gICAgLnRoZW4ocmVzID0+IHJlcy5ibG9iKCkpXG4gICAgLnRoZW4oYmxvYiA9PiBzYXZlQmxvYihibG9iLCBvcHRzKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzYXZlQmxvYiAoYmxvYiwgb3B0cyA9IHt9KSB7XG4gIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICBvcHRzID0gYXNzaWduKHsgZXh0ZW5zaW9uOiAnJywgcHJlZml4OiAnJywgc3VmZml4OiAnJyB9LCBvcHRzKTtcbiAgICBjb25zdCBmaWxlbmFtZSA9IHJlc29sdmVGaWxlbmFtZShvcHRzKTtcblxuICAgIGNvbnN0IGNsaWVudCA9IGdldENsaWVudEFQSSgpO1xuICAgIGlmIChjbGllbnQgJiYgdHlwZW9mIGNsaWVudC5zYXZlQmxvYiA9PT0gJ2Z1bmN0aW9uJyAmJiBjbGllbnQub3V0cHV0KSB7XG4gICAgICAvLyBuYXRpdmUgc2F2aW5nIHVzaW5nIGEgQ0xJIHRvb2xcbiAgICAgIHJldHVybiBjbGllbnQuc2F2ZUJsb2IoYmxvYiwgYXNzaWduKHt9LCBvcHRzLCB7IGZpbGVuYW1lIH0pKVxuICAgICAgICAudGhlbihldiA9PiByZXNvbHZlKGV2KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGZvcmNlIGRvd25sb2FkXG4gICAgICBpZiAoIWxpbmspIGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XG4gICAgICBsaW5rLmRvd25sb2FkID0gZmlsZW5hbWU7XG4gICAgICBsaW5rLmhyZWYgPSB3aW5kb3cuVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTtcbiAgICAgIGxpbmsub25jbGljayA9ICgpID0+IHtcbiAgICAgICAgbGluay5vbmNsaWNrID0gbm9vcDtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgd2luZG93LlVSTC5yZXZva2VPYmplY3RVUkwoYmxvYik7XG4gICAgICAgICAgbGluay5yZW1vdmVBdHRyaWJ1dGUoJ2hyZWYnKTtcbiAgICAgICAgICByZXNvbHZlKHsgZmlsZW5hbWUsIGNsaWVudDogZmFsc2UgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfTtcbiAgICAgIGxpbmsuY2xpY2soKTtcbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2F2ZUZpbGUgKGRhdGEsIG9wdHMgPSB7fSkge1xuICBjb25zdCBwYXJ0cyA9IEFycmF5LmlzQXJyYXkoZGF0YSkgPyBkYXRhIDogWyBkYXRhIF07XG4gIGNvbnN0IGJsb2IgPSBuZXcgd2luZG93LkJsb2IocGFydHMsIHsgdHlwZTogb3B0cy50eXBlIHx8ICcnIH0pO1xuICByZXR1cm4gc2F2ZUJsb2IoYmxvYiwgb3B0cyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRGaWxlTmFtZSAoKSB7XG4gIGNvbnN0IGRhdGVGb3JtYXRTdHIgPSBgeXl5eS5tbS5kZC1ISC5NTS5zc2A7XG4gIHJldHVybiBkYXRlZm9ybWF0KG5ldyBEYXRlKCksIGRhdGVGb3JtYXRTdHIpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVmYXVsdEZpbGUgKHByZWZpeCA9ICcnLCBzdWZmaXggPSAnJywgZXh0KSB7XG4gIC8vIGNvbnN0IGRhdGVGb3JtYXRTdHIgPSBgeXl5eS5tbS5kZC1ISC5NTS5zc2A7XG4gIGNvbnN0IGRhdGVGb3JtYXRTdHIgPSBgeXl5eS1tbS1kZCAnYXQnIGguTU0uc3MgVFRgO1xuICByZXR1cm4gYCR7cHJlZml4fSR7ZGF0ZWZvcm1hdChuZXcgRGF0ZSgpLCBkYXRlRm9ybWF0U3RyKX0ke3N1ZmZpeH0ke2V4dH1gO1xufVxuXG5mdW5jdGlvbiByZXNvbHZlRmlsZW5hbWUgKG9wdCA9IHt9KSB7XG4gIG9wdCA9IGFzc2lnbih7fSwgb3B0KTtcblxuICAvLyBDdXN0b20gZmlsZW5hbWUgZnVuY3Rpb25cbiAgaWYgKHR5cGVvZiBvcHQuZmlsZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiBvcHQuZmlsZShvcHQpO1xuICB9IGVsc2UgaWYgKG9wdC5maWxlKSB7XG4gICAgcmV0dXJuIG9wdC5maWxlO1xuICB9XG5cbiAgbGV0IGZyYW1lID0gbnVsbDtcbiAgbGV0IGV4dGVuc2lvbiA9ICcnO1xuICBpZiAodHlwZW9mIG9wdC5leHRlbnNpb24gPT09ICdzdHJpbmcnKSBleHRlbnNpb24gPSBvcHQuZXh0ZW5zaW9uO1xuXG4gIGlmICh0eXBlb2Ygb3B0LmZyYW1lID09PSAnbnVtYmVyJykge1xuICAgIGxldCB0b3RhbEZyYW1lcztcbiAgICBpZiAodHlwZW9mIG9wdC50b3RhbEZyYW1lcyA9PT0gJ251bWJlcicpIHtcbiAgICAgIHRvdGFsRnJhbWVzID0gb3B0LnRvdGFsRnJhbWVzO1xuICAgIH0gZWxzZSB7XG4gICAgICB0b3RhbEZyYW1lcyA9IE1hdGgubWF4KDEwMDAsIG9wdC5mcmFtZSk7XG4gICAgfVxuICAgIGZyYW1lID0gcGFkTGVmdChTdHJpbmcob3B0LmZyYW1lKSwgU3RyaW5nKHRvdGFsRnJhbWVzKS5sZW5ndGgsICcwJyk7XG4gIH1cblxuICBjb25zdCBsYXllclN0ciA9IGlzRmluaXRlKG9wdC50b3RhbExheWVycykgJiYgaXNGaW5pdGUob3B0LmxheWVyKSAmJiBvcHQudG90YWxMYXllcnMgPiAxID8gYCR7b3B0LmxheWVyfWAgOiAnJztcbiAgaWYgKGZyYW1lICE9IG51bGwpIHtcbiAgICByZXR1cm4gWyBsYXllclN0ciwgZnJhbWUgXS5maWx0ZXIoQm9vbGVhbikuam9pbignLScpICsgZXh0ZW5zaW9uO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGRlZmF1bHRGaWxlTmFtZSA9IG9wdC50aW1lU3RhbXA7XG4gICAgcmV0dXJuIFsgb3B0LnByZWZpeCwgb3B0Lm5hbWUgfHwgZGVmYXVsdEZpbGVOYW1lLCBsYXllclN0ciwgb3B0Lmhhc2gsIG9wdC5zdWZmaXggXS5maWx0ZXIoQm9vbGVhbikuam9pbignLScpICsgZXh0ZW5zaW9uO1xuICB9XG59XG4iLCJpbXBvcnQgZGVmaW5lZCBmcm9tICdkZWZpbmVkJztcbmltcG9ydCBhc3NpZ24gZnJvbSAnb2JqZWN0LWFzc2lnbic7XG5pbXBvcnQgZ2V0Q2FudmFzQ29udGV4dCBmcm9tICdnZXQtY2FudmFzLWNvbnRleHQnO1xuaW1wb3J0IHJpZ2h0Tm93IGZyb20gJ3JpZ2h0LW5vdyc7XG5pbXBvcnQgaXNQcm9taXNlIGZyb20gJ2lzLXByb21pc2UnO1xuaW1wb3J0IFBhcGVyU2l6ZSBmcm9tICcuL3BhcGVyLXNpemVzJztcbmltcG9ydCB7IGdldERpbWVuc2lvbnNGcm9tUHJlc2V0LCBjb252ZXJ0RGlzdGFuY2UgfSBmcm9tICcuL2Rpc3RhbmNlcyc7XG5pbXBvcnQgeyBpc1dlYkdMQ29udGV4dCwgaXNDYW52YXMsIGdldENsaWVudEFQSSB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgZGVlcEVxdWFsIGZyb20gJ2RlZXAtZXF1YWwnO1xuaW1wb3J0IHsgc2F2ZUZpbGUsIHNhdmVEYXRhVVJMLCBnZXRGaWxlTmFtZSB9IGZyb20gJy4vc2F2ZSc7XG5cbmNvbnN0IGlzQnJvd3NlciA9ICgpID0+IHR5cGVvZiBkb2N1bWVudCAhPT0gJ3VuZGVmaW5lZCc7XG5cbi8vIFdoZW4gbm8geyBkaW1lbnNpb24gfSBpcyBwYXNzZWQgaW4gbm9kZSwgd2UgZGVmYXVsdCB0byBIVE1MIGNhbnZhcyBzaXplXG5jb25zdCBkZWZhdWx0Tm9kZVNpemUgPSBbIDMwMCwgMTUwIF07XG5cbmNsYXNzIFNrZXRjaE1hbmFnZXIge1xuICBjb25zdHJ1Y3RvciAoKSB7XG4gICAgdGhpcy5fc2V0dGluZ3MgPSB7fTtcbiAgICB0aGlzLl9wcm9wcyA9IHt9O1xuICAgIHRoaXMuX3NrZXRjaCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLl9yYWYgPSBudWxsO1xuXG4gICAgLy8gU29tZSBoYWNreSB0aGluZ3MgcmVxdWlyZWQgdG8gZ2V0IGFyb3VuZCBwNS5qcyBzdHJ1Y3R1cmVcbiAgICB0aGlzLl9sYXN0UmVkcmF3UmVzdWx0ID0gdW5kZWZpbmVkO1xuICAgIHRoaXMuX2lzUDVSZXNpemluZyA9IGZhbHNlO1xuXG4gICAgdGhpcy5fYW5pbWF0ZUhhbmRsZXIgPSAoKSA9PiB0aGlzLmFuaW1hdGUoKTtcblxuICAgIHRoaXMuX3Jlc2l6ZUhhbmRsZXIgPSAoKSA9PiB7XG4gICAgICBjb25zdCBvbGRTaXplcyA9IHRoaXMuX2dldFNpemVQcm9wcygpO1xuICAgICAgdGhpcy5yZXNpemUoKTtcblxuICAgICAgLy8gVGhpcyBpcyB0byBhdm9pZCB1bm5lY2Vzc2FyeSByZS1yZW5kZXJzIG9uIHJlc2l6ZSxcbiAgICAgIC8vIGFzIGEgbG90IG9mIGdlbmVyYXRpdmUgYXJ0IHByb2plY3RzIGNhbiBiZSBzbG93IHRvIHJlbmRlci5cbiAgICAgIGNvbnN0IG5ld1NpemVzID0gdGhpcy5fZ2V0U2l6ZVByb3BzKCk7XG4gICAgICBpZiAoIWRlZXBFcXVhbChvbGRTaXplcywgbmV3U2l6ZXMpKSB7XG4gICAgICAgIHRoaXMucmVuZGVyKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMuX2V4cG9ydEhhbmRsZXIgPSBldiA9PiB7XG4gICAgICBpZiAodGhpcy5zZXR0aW5ncy5ob3RrZXlzID09PSBmYWxzZSkgcmV0dXJuO1xuXG4gICAgICBjb25zdCBjbGllbnQgPSBnZXRDbGllbnRBUEkoKTtcbiAgICAgIGlmIChldi5rZXlDb2RlID09PSA4MyAmJiAhZXYuYWx0S2V5ICYmIChldi5tZXRhS2V5IHx8IGV2LmN0cmxLZXkpKSB7XG4gICAgICAgIC8vIENtZCArIFNcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgaWYgKGV2LnNoaWZ0S2V5KSB7XG4gICAgICAgICAgaWYgKHRoaXMucHJvcHMucmVjb3JkaW5nKSB7XG4gICAgICAgICAgICB0aGlzLmVuZFJlY29yZCgpO1xuICAgICAgICAgICAgdGhpcy5wbGF5KCk7XG4gICAgICAgICAgfSBlbHNlIHRoaXMucmVjb3JkKCk7XG4gICAgICAgIH0gZWxzZSB0aGlzLmV4cG9ydEZyYW1lKCk7XG4gICAgICB9IGVsc2UgaWYgKGV2LmtleUNvZGUgPT09IDMyKSB7XG4gICAgICAgIC8vIFNwYWNlXG4gICAgICAgIC8vIFRPRE86IHdoYXQgdG8gZG8gd2l0aCB0aGlzPyBrZWVwIGl0LCBvciByZW1vdmUgaXQ/XG4gICAgICAgIGlmICh0aGlzLnByb3BzLnBsYXlpbmcpIHRoaXMucGF1c2UoKTtcbiAgICAgICAgZWxzZSB0aGlzLnBsYXkoKTtcbiAgICAgIH0gZWxzZSBpZiAoY2xpZW50ICYmICFldi5hbHRLZXkgJiYgZXYua2V5Q29kZSA9PT0gNzUgJiYgKGV2Lm1ldGFLZXkgfHwgZXYuY3RybEtleSkpIHtcbiAgICAgICAgLy8gQ21kICsgSywgb25seSB3aGVuIGNhbnZhcy1za2V0Y2gtY2xpIGlzIHVzZWRcbiAgICAgICAgZXYucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5leHBvcnRGcmFtZSh7IGNvbW1pdDogdHJ1ZSB9KTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgZ2V0IHNrZXRjaCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NrZXRjaDtcbiAgfVxuXG4gIGdldCBzZXR0aW5ncyAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NldHRpbmdzO1xuICB9XG5cbiAgZ2V0IHByb3BzICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcHJvcHM7XG4gIH1cblxuICBfY29tcHV0ZVBsYXloZWFkIChjdXJyZW50VGltZSwgZHVyYXRpb24pIHtcbiAgICBjb25zdCBoYXNEdXJhdGlvbiA9IHR5cGVvZiBkdXJhdGlvbiA9PT0gJ251bWJlcicgJiYgaXNGaW5pdGUoZHVyYXRpb24pO1xuICAgIHJldHVybiBoYXNEdXJhdGlvbiA/IGN1cnJlbnRUaW1lIC8gZHVyYXRpb24gOiAwO1xuICB9XG5cbiAgX2NvbXB1dGVGcmFtZSAocGxheWhlYWQsIHRpbWUsIHRvdGFsRnJhbWVzLCBmcHMpIHtcbiAgICByZXR1cm4gKGlzRmluaXRlKHRvdGFsRnJhbWVzKSAmJiB0b3RhbEZyYW1lcyA+IDEpXG4gICAgICA/IE1hdGguZmxvb3IocGxheWhlYWQgKiAodG90YWxGcmFtZXMgLSAxKSlcbiAgICAgIDogTWF0aC5mbG9vcihmcHMgKiB0aW1lKTtcbiAgfVxuXG4gIF9jb21wdXRlQ3VycmVudEZyYW1lICgpIHtcbiAgICByZXR1cm4gdGhpcy5fY29tcHV0ZUZyYW1lKFxuICAgICAgdGhpcy5wcm9wcy5wbGF5aGVhZCwgdGhpcy5wcm9wcy50aW1lLFxuICAgICAgdGhpcy5wcm9wcy50b3RhbEZyYW1lcywgdGhpcy5wcm9wcy5mcHNcbiAgICApO1xuICB9XG5cbiAgX2dldFNpemVQcm9wcyAoKSB7XG4gICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BzO1xuICAgIHJldHVybiB7XG4gICAgICB3aWR0aDogcHJvcHMud2lkdGgsXG4gICAgICBoZWlnaHQ6IHByb3BzLmhlaWdodCxcbiAgICAgIHBpeGVsUmF0aW86IHByb3BzLnBpeGVsUmF0aW8sXG4gICAgICBjYW52YXNXaWR0aDogcHJvcHMuY2FudmFzV2lkdGgsXG4gICAgICBjYW52YXNIZWlnaHQ6IHByb3BzLmNhbnZhc0hlaWdodCxcbiAgICAgIHZpZXdwb3J0V2lkdGg6IHByb3BzLnZpZXdwb3J0V2lkdGgsXG4gICAgICB2aWV3cG9ydEhlaWdodDogcHJvcHMudmlld3BvcnRIZWlnaHRcbiAgICB9O1xuICB9XG5cbiAgcnVuICgpIHtcbiAgICBpZiAoIXRoaXMuc2tldGNoKSB0aHJvdyBuZXcgRXJyb3IoJ3Nob3VsZCB3YWl0IHVudGlsIHNrZXRjaCBpcyBsb2FkZWQgYmVmb3JlIHRyeWluZyB0byBwbGF5KCknKTtcblxuICAgIC8vIFN0YXJ0IGFuIGFuaW1hdGlvbiBmcmFtZSBsb29wIGlmIG5lY2Vzc2FyeVxuICAgIGlmICh0aGlzLnNldHRpbmdzLnBsYXlpbmcgIT09IGZhbHNlKSB7XG4gICAgICB0aGlzLnBsYXkoKTtcbiAgICB9XG5cbiAgICAvLyBJbiBjYXNlIHdlIGFyZW4ndCBwbGF5aW5nIG9yIGFuaW1hdGVkLCBtYWtlIHN1cmUgd2Ugc3RpbGwgdHJpZ2dlciBiZWdpbiBtZXNzYWdlLi4uXG4gICAgaWYgKCF0aGlzLnByb3BzLnN0YXJ0ZWQpIHtcbiAgICAgIHRoaXMuX3NpZ25hbEJlZ2luKCk7XG4gICAgICB0aGlzLnByb3BzLnN0YXJ0ZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIC8vIFJlbmRlciBhbiBpbml0aWFsIGZyYW1lXG4gICAgdGhpcy50aWNrKCk7XG4gICAgdGhpcy5yZW5kZXIoKTtcbiAgfVxuXG4gIHBsYXkgKCkge1xuICAgIGxldCBhbmltYXRlID0gdGhpcy5zZXR0aW5ncy5hbmltYXRlO1xuICAgIGlmICgnYW5pbWF0aW9uJyBpbiB0aGlzLnNldHRpbmdzKSB7XG4gICAgICBhbmltYXRlID0gdHJ1ZTtcbiAgICAgIGNvbnNvbGUud2FybignW2NhbnZhcy1za2V0Y2hdIHsgYW5pbWF0aW9uIH0gaGFzIGJlZW4gcmVuYW1lZCB0byB7IGFuaW1hdGUgfScpO1xuICAgIH1cbiAgICBpZiAoIWFuaW1hdGUpIHJldHVybjtcbiAgICBpZiAoIWlzQnJvd3NlcigpKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdbY2FudmFzLXNrZXRjaF0gV0FSTjogVXNpbmcgeyBhbmltYXRlIH0gaW4gTm9kZS5qcyBpcyBub3QgeWV0IHN1cHBvcnRlZCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIXRoaXMucHJvcHMuc3RhcnRlZCkge1xuICAgICAgdGhpcy5fc2lnbmFsQmVnaW4oKTtcbiAgICAgIHRoaXMucHJvcHMuc3RhcnRlZCA9IHRydWU7XG4gICAgfVxuICAgIC8vIFN0YXJ0IGEgcmVuZGVyIGxvb3BcbiAgICB0aGlzLnByb3BzLnBsYXlpbmcgPSB0cnVlO1xuICAgIGlmICh0aGlzLl9yYWYgIT0gbnVsbCkgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuX3JhZik7XG4gICAgdGhpcy5fbGFzdFRpbWUgPSByaWdodE5vdygpO1xuICAgIHRoaXMuX3JhZiA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5fYW5pbWF0ZUhhbmRsZXIpO1xuICB9XG5cbiAgcGF1c2UgKCkge1xuICAgIGlmICh0aGlzLnByb3BzLnJlY29yZGluZykgdGhpcy5lbmRSZWNvcmQoKTtcbiAgICB0aGlzLnByb3BzLnBsYXlpbmcgPSBmYWxzZTtcbiAgICBpZiAodGhpcy5fcmFmICE9IG51bGwgJiYgaXNCcm93c2VyKCkpIHdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLl9yYWYpO1xuICB9XG5cbiAgLy8gU3RvcCBhbmQgcmVzZXQgdG8gZnJhbWUgemVyb1xuICBzdG9wICgpIHtcbiAgICB0aGlzLnBhdXNlKCk7XG4gICAgdGhpcy5wcm9wcy5mcmFtZSA9IDA7XG4gICAgdGhpcy5wcm9wcy5wbGF5aGVhZCA9IDA7XG4gICAgdGhpcy5wcm9wcy50aW1lID0gMDtcbiAgICB0aGlzLnByb3BzLmRlbHRhVGltZSA9IDA7XG4gICAgdGhpcy5wcm9wcy5zdGFydGVkID0gZmFsc2U7XG4gICAgdGhpcy5yZW5kZXIoKTtcbiAgfVxuXG4gIHJlY29yZCAoKSB7XG4gICAgaWYgKHRoaXMucHJvcHMucmVjb3JkaW5nKSByZXR1cm47XG4gICAgaWYgKCFpc0Jyb3dzZXIoKSkge1xuICAgICAgY29uc29sZS5lcnJvcignW2NhbnZhcy1za2V0Y2hdIFdBUk46IFJlY29yZGluZyBmcm9tIE5vZGUuanMgaXMgbm90IHlldCBzdXBwb3J0ZWQnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zdG9wKCk7XG4gICAgdGhpcy5wcm9wcy5wbGF5aW5nID0gdHJ1ZTtcbiAgICB0aGlzLnByb3BzLnJlY29yZGluZyA9IHRydWU7XG5cbiAgICBjb25zdCBmcmFtZUludGVydmFsID0gMSAvIHRoaXMucHJvcHMuZnBzO1xuICAgIC8vIFJlbmRlciBlYWNoIGZyYW1lIGluIHRoZSBzZXF1ZW5jZVxuICAgIGlmICh0aGlzLl9yYWYgIT0gbnVsbCkgd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuX3JhZik7XG4gICAgY29uc3QgdGljayA9ICgpID0+IHtcbiAgICAgIGlmICghdGhpcy5wcm9wcy5yZWNvcmRpbmcpIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgIHRoaXMucHJvcHMuZGVsdGFUaW1lID0gZnJhbWVJbnRlcnZhbDtcbiAgICAgIHRoaXMudGljaygpO1xuICAgICAgcmV0dXJuIHRoaXMuZXhwb3J0RnJhbWUoeyBzZXF1ZW5jZTogdHJ1ZSB9KVxuICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgaWYgKCF0aGlzLnByb3BzLnJlY29yZGluZykgcmV0dXJuOyAvLyB3YXMgY2FuY2VsbGVkIGJlZm9yZVxuICAgICAgICAgIHRoaXMucHJvcHMuZGVsdGFUaW1lID0gMDtcbiAgICAgICAgICB0aGlzLnByb3BzLmZyYW1lKys7XG4gICAgICAgICAgaWYgKHRoaXMucHJvcHMuZnJhbWUgPCB0aGlzLnByb3BzLnRvdGFsRnJhbWVzKSB7XG4gICAgICAgICAgICB0aGlzLnByb3BzLnRpbWUgKz0gZnJhbWVJbnRlcnZhbDtcbiAgICAgICAgICAgIHRoaXMucHJvcHMucGxheWhlYWQgPSB0aGlzLl9jb21wdXRlUGxheWhlYWQodGhpcy5wcm9wcy50aW1lLCB0aGlzLnByb3BzLmR1cmF0aW9uKTtcbiAgICAgICAgICAgIHRoaXMuX3JhZiA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGljayk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdGaW5pc2hlZCByZWNvcmRpbmcnKTtcbiAgICAgICAgICAgIHRoaXMuX3NpZ25hbEVuZCgpO1xuICAgICAgICAgICAgdGhpcy5lbmRSZWNvcmQoKTtcbiAgICAgICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICAgICAgdGhpcy5ydW4oKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH07XG5cbiAgICAvLyBUcmlnZ2VyIGEgc3RhcnQgZXZlbnQgYmVmb3JlIHdlIGJlZ2luIHJlY29yZGluZ1xuICAgIGlmICghdGhpcy5wcm9wcy5zdGFydGVkKSB7XG4gICAgICB0aGlzLl9zaWduYWxCZWdpbigpO1xuICAgICAgdGhpcy5wcm9wcy5zdGFydGVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICB0aGlzLl9yYWYgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRpY2spO1xuICB9XG5cbiAgX3NpZ25hbEJlZ2luICgpIHtcbiAgICBpZiAodGhpcy5za2V0Y2ggJiYgdHlwZW9mIHRoaXMuc2tldGNoLmJlZ2luID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aGlzLl93cmFwQ29udGV4dFNjYWxlKCgpID0+IHRoaXMuc2tldGNoLmJlZ2luKHRoaXMucHJvcHMpKTtcbiAgICB9XG4gIH1cblxuICBfc2lnbmFsRW5kICgpIHtcbiAgICBpZiAodGhpcy5za2V0Y2ggJiYgdHlwZW9mIHRoaXMuc2tldGNoLmVuZCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgdGhpcy5fd3JhcENvbnRleHRTY2FsZSgoKSA9PiB0aGlzLnNrZXRjaC5lbmQodGhpcy5wcm9wcykpO1xuICAgIH1cbiAgfVxuXG4gIGVuZFJlY29yZCAoKSB7XG4gICAgaWYgKHRoaXMuX3JhZiAhPSBudWxsICYmIGlzQnJvd3NlcigpKSB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5fcmFmKTtcbiAgICB0aGlzLnByb3BzLnJlY29yZGluZyA9IGZhbHNlO1xuICAgIHRoaXMucHJvcHMuZGVsdGFUaW1lID0gMDtcbiAgfVxuXG4gIGV4cG9ydEZyYW1lIChvcHQgPSB7fSkge1xuICAgIGlmICghdGhpcy5za2V0Y2gpIHJldHVybiBQcm9taXNlLmFsbChbXSk7XG4gICAgaWYgKHR5cGVvZiB0aGlzLnNrZXRjaC5wcmVFeHBvcnQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRoaXMuc2tldGNoLnByZUV4cG9ydCgpO1xuICAgIH1cblxuICAgIC8vIE9wdGlvbnMgZm9yIGV4cG9ydCBmdW5jdGlvblxuICAgIGxldCBleHBvcnRPcHRzID0gYXNzaWduKHtcbiAgICAgIHNlcXVlbmNlOiBvcHQuc2VxdWVuY2UsXG4gICAgICBmcmFtZTogb3B0LnNlcXVlbmNlID8gdGhpcy5wcm9wcy5mcmFtZSA6IHVuZGVmaW5lZCxcbiAgICAgIGZpbGU6IHRoaXMuc2V0dGluZ3MuZmlsZSxcbiAgICAgIG5hbWU6IHRoaXMuc2V0dGluZ3MubmFtZSxcbiAgICAgIHByZWZpeDogdGhpcy5zZXR0aW5ncy5wcmVmaXgsXG4gICAgICBzdWZmaXg6IHRoaXMuc2V0dGluZ3Muc3VmZml4LFxuICAgICAgdGltZVN0YW1wOiBnZXRGaWxlTmFtZSgpLFxuICAgICAgdG90YWxGcmFtZXM6IGlzRmluaXRlKHRoaXMucHJvcHMudG90YWxGcmFtZXMpID8gTWF0aC5tYXgoMTAwLCB0aGlzLnByb3BzLnRvdGFsRnJhbWVzKSA6IDEwMDBcbiAgICB9KTtcblxuICAgIGNvbnN0IGNsaWVudCA9IGdldENsaWVudEFQSSgpO1xuICAgIGxldCBwID0gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgaWYgKGNsaWVudCAmJiBvcHQuY29tbWl0ICYmIHR5cGVvZiBjbGllbnQuY29tbWl0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjb25zdCBjb21taXRPcHRzID0gYXNzaWduKHt9LCBleHBvcnRPcHRzKTtcbiAgICAgIGNvbnN0IGhhc2ggPSBjbGllbnQuY29tbWl0KGNvbW1pdE9wdHMpO1xuICAgICAgaWYgKGlzUHJvbWlzZShoYXNoKSkgcCA9IGhhc2g7XG4gICAgICBlbHNlIHAgPSBQcm9taXNlLnJlc29sdmUoaGFzaCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHAudGhlbihoYXNoID0+IHtcbiAgICAgIHJldHVybiB0aGlzLl9kb0V4cG9ydEZyYW1lKGFzc2lnbih7fSwgZXhwb3J0T3B0cywgeyBoYXNoOiBoYXNoIHx8ICcnIH0pKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9kb0V4cG9ydEZyYW1lIChleHBvcnRPcHRzID0ge30pIHtcbiAgICB0aGlzLl9wcm9wcy5leHBvcnRpbmcgPSB0cnVlO1xuXG4gICAgLy8gUmVzaXplIHRvIG91dHB1dCByZXNvbHV0aW9uXG4gICAgdGhpcy5yZXNpemUoKTtcblxuICAgIC8vIERyYXcgYXQgdGhpcyBvdXRwdXQgcmVzb2x1dGlvblxuICAgIGxldCBkcmF3UmVzdWx0ID0gdGhpcy5yZW5kZXIoKTtcblxuICAgIC8vIFRoZSBzZWxmIG93bmVkIGNhbnZhcyAobWF5IGJlIHVuZGVmaW5lZC4uLiEpXG4gICAgY29uc3QgY2FudmFzID0gdGhpcy5wcm9wcy5jYW52YXM7XG5cbiAgICAvLyBHZXQgbGlzdCBvZiByZXN1bHRzIGZyb20gcmVuZGVyXG4gICAgaWYgKHR5cGVvZiBkcmF3UmVzdWx0ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgZHJhd1Jlc3VsdCA9IFsgY2FudmFzIF07XG4gICAgfVxuICAgIGRyYXdSZXN1bHQgPSBbXS5jb25jYXQoZHJhd1Jlc3VsdCkuZmlsdGVyKEJvb2xlYW4pO1xuXG4gICAgLy8gVHJhbnNmb3JtIHRoZSBjYW52YXMvZmlsZSBkZXNjcmlwdG9ycyBpbnRvIGEgY29uc2lzdGVudCBmb3JtYXQsXG4gICAgLy8gYW5kIHB1bGwgb3V0IGFueSBkYXRhIFVSTHMgZnJvbSBjYW52YXMgZWxlbWVudHNcbiAgICBkcmF3UmVzdWx0ID0gZHJhd1Jlc3VsdC5tYXAocmVzdWx0ID0+IHtcbiAgICAgIGNvbnN0IGhhc0RhdGFPYmplY3QgPSB0eXBlb2YgcmVzdWx0ID09PSAnb2JqZWN0JyAmJiByZXN1bHQgJiYgJ2RhdGEnIGluIHJlc3VsdDtcbiAgICAgIGNvbnN0IGRhdGEgPSBoYXNEYXRhT2JqZWN0ID8gcmVzdWx0LmRhdGEgOiByZXN1bHQ7XG4gICAgICBjb25zdCBvcHRzID0gaGFzRGF0YU9iamVjdCA/IGFzc2lnbih7fSwgcmVzdWx0LCB7IGRhdGEgfSkgOiB7IGRhdGEgfTtcblxuICAgICAgaWYgKGlzQ2FudmFzKGRhdGEpKSB7XG4gICAgICAgIC8vIFByb3ZpZGUgZGF0YSBVUkwgaGludFxuICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihvcHRzLCB7IHVybDogZGF0YS50b0RhdGFVUkwoJ2ltYWdlL3BuZycpLCBleHRlbnNpb246ICcucG5nJywgdHlwZTogJ2ltYWdlL3BuZycgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gb3B0cztcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIC8vIE5vdyByZXR1cm4gdG8gcmVndWxhciByZW5kZXJpbmcgbW9kZVxuICAgIHRoaXMuX3Byb3BzLmV4cG9ydGluZyA9IGZhbHNlO1xuICAgIHRoaXMucmVzaXplKCk7XG4gICAgdGhpcy5yZW5kZXIoKTtcblxuICAgIC8vIEFuZCBub3cgd2UgY2FuIHNhdmUgZWFjaCByZXN1bHRcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoZHJhd1Jlc3VsdC5tYXAoKHJlc3VsdCwgaSwgbGF5ZXJMaXN0KSA9PiB7XG4gICAgICAvLyBCeSBkZWZhdWx0LCBpZiByZW5kZXJpbmcgbXVsdGlwbGUgbGF5ZXJzIHdlIHdpbGwgZ2l2ZSB0aGVtIGluZGljZXNcbiAgICAgIGNvbnN0IGN1ck9wdCA9IGFzc2lnbih7fSwgZXhwb3J0T3B0cywgcmVzdWx0LCB7IGxheWVyOiBpLCB0b3RhbExheWVyczogbGF5ZXJMaXN0Lmxlbmd0aCB9KTtcbiAgICAgIGNvbnN0IGRhdGEgPSByZXN1bHQuZGF0YTtcbiAgICAgIGlmIChyZXN1bHQudXJsKSB7XG4gICAgICAgIGNvbnN0IHVybCA9IHJlc3VsdC51cmw7XG4gICAgICAgIGRlbGV0ZSBjdXJPcHQudXJsOyAvLyBhdm9pZCBzZW5kaW5nIGVudGlyZSBiYXNlNjQgZGF0YSBhcm91bmRcbiAgICAgICAgcmV0dXJuIHNhdmVEYXRhVVJMKHVybCwgY3VyT3B0KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBzYXZlRmlsZShkYXRhLCBjdXJPcHQpO1xuICAgICAgfVxuICAgIH0pKS50aGVuKGV2ID0+IHtcbiAgICAgIGlmIChldi5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IGV2ZW50V2l0aE91dHB1dCA9IGV2LmZpbmQoZSA9PiBlLm91dHB1dE5hbWUpO1xuICAgICAgICBjb25zdCBpc0NsaWVudCA9IGV2LnNvbWUoZSA9PiBlLmNsaWVudCk7XG4gICAgICAgIGxldCBpdGVtO1xuICAgICAgICAvLyBtYW55IGZpbGVzLCBqdXN0IGxvZyBob3cgbWFueSB3ZXJlIGV4cG9ydGVkXG4gICAgICAgIGlmIChldi5sZW5ndGggPiAxKSBpdGVtID0gZXYubGVuZ3RoO1xuICAgICAgICAvLyBpbiBDTEksIHdlIGtub3cgZXhhY3QgcGF0aCBkaXJuYW1lXG4gICAgICAgIGVsc2UgaWYgKGV2ZW50V2l0aE91dHB1dCkgaXRlbSA9IGAke2V2ZW50V2l0aE91dHB1dC5vdXRwdXROYW1lfS8ke2V2WzBdLmZpbGVuYW1lfWA7XG4gICAgICAgIC8vIGluIGJyb3dzZXIsIHdlIGNhbiBvbmx5IGtub3cgaXQgd2VudCB0byBcImJyb3dzZXIgZG93bmxvYWQgZm9sZGVyXCJcbiAgICAgICAgZWxzZSBpdGVtID0gYCR7ZXZbMF0uZmlsZW5hbWV9YDtcbiAgICAgICAgbGV0IG9mU2VxID0gJyc7XG4gICAgICAgIGlmIChleHBvcnRPcHRzLnNlcXVlbmNlKSB7XG4gICAgICAgICAgY29uc3QgaGFzVG90YWxGcmFtZXMgPSBpc0Zpbml0ZSh0aGlzLnByb3BzLnRvdGFsRnJhbWVzKTtcbiAgICAgICAgICBvZlNlcSA9IGhhc1RvdGFsRnJhbWVzID8gYCAoZnJhbWUgJHtleHBvcnRPcHRzLmZyYW1lICsgMX0gLyAke3RoaXMucHJvcHMudG90YWxGcmFtZXN9KWAgOiBgIChmcmFtZSAke2V4cG9ydE9wdHMuZnJhbWV9KWA7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2xpZW50ID0gaXNDbGllbnQgPyAnY2FudmFzLXNrZXRjaC1jbGknIDogJ2NhbnZhcy1za2V0Y2gnO1xuICAgICAgICBjb25zb2xlLmxvZyhgJWNbJHtjbGllbnR9XSVjIEV4cG9ydGVkICVjJHtpdGVtfSVjJHtvZlNlcX1gLCAnY29sb3I6ICM4ZThlOGU7JywgJ2NvbG9yOiBpbml0aWFsOycsICdmb250LXdlaWdodDogYm9sZDsnLCAnZm9udC13ZWlnaHQ6IGluaXRpYWw7Jyk7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIHRoaXMuc2tldGNoLnBvc3RFeHBvcnQgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgdGhpcy5za2V0Y2gucG9zdEV4cG9ydCgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgX2lzQXV0b1NjYWxlICgpIHtcbiAgICByZXR1cm4gIXRoaXMucHJvcHMuZ2wgJiYgdGhpcy5zZXR0aW5ncy5zY2FsZUNvbnRleHQgIT09IGZhbHNlO1xuICB9XG5cbiAgX3dyYXBDb250ZXh0U2NhbGUgKGNiKSB7XG4gICAgdGhpcy5fcHJlUmVuZGVyKCk7XG4gICAgY2IoKTtcbiAgICB0aGlzLl9wb3N0UmVuZGVyKCk7XG4gIH1cblxuICBfcHJlUmVuZGVyICgpIHtcbiAgICBjb25zdCBwcm9wcyA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgYXV0b1NjYWxlID0gdGhpcy5faXNBdXRvU2NhbGUoKTtcblxuICAgIC8vIFNjYWxlIGNvbnRleHQgZm9yIHVuaXQgc2l6aW5nXG4gICAgaWYgKGF1dG9TY2FsZSAmJiBwcm9wcy5jb250ZXh0ICYmICFwcm9wcy5wNSkge1xuICAgICAgcHJvcHMuY29udGV4dC5zYXZlKCk7XG4gICAgICBwcm9wcy5jb250ZXh0LnNjYWxlKHByb3BzLnNjYWxlWCwgcHJvcHMuc2NhbGVZKTtcbiAgICB9IGVsc2UgaWYgKHByb3BzLnA1KSB7XG4gICAgICBwcm9wcy5wNS5zY2FsZShwcm9wcy5zY2FsZVggLyBwcm9wcy5waXhlbFJhdGlvLCBwcm9wcy5zY2FsZVkgLyBwcm9wcy5waXhlbFJhdGlvKTtcbiAgICB9XG4gIH1cblxuICBfcG9zdFJlbmRlciAoKSB7XG4gICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IGF1dG9TY2FsZSA9IHRoaXMuX2lzQXV0b1NjYWxlKCk7XG5cbiAgICBpZiAoYXV0b1NjYWxlICYmIHByb3BzLmNvbnRleHQgJiYgIXByb3BzLnA1KSB7XG4gICAgICBwcm9wcy5jb250ZXh0LnJlc3RvcmUoKTtcbiAgICB9XG5cbiAgICAvLyBGbHVzaCBieSBkZWZhdWx0LCB0aGlzIG1heSBiZSByZXZpc2l0ZWQgYXQgYSBsYXRlciBwb2ludC5cbiAgICAvLyBXZSBkbyB0aGlzIHRvIGVuc3VyZSB0b0RhdGFVUkwgY2FuIGJlIGNhbGxlZCBpbW1lZGlhdGVseSBhZnRlci5cbiAgICAvLyBNb3N0IGxpa2VseSBicm93c2VycyBhbHJlYWR5IGhhbmRsZSB0aGlzLCBzbyB3ZSBtYXkgcmV2aXNpdCB0aGlzIGFuZFxuICAgIC8vIHJlbW92ZSBpdCBpZiBpdCBpbXByb3ZlcyBwZXJmb3JtYW5jZSB3aXRob3V0IGFueSB1c2FiaWxpdHkgaXNzdWVzLlxuICAgIGlmIChwcm9wcy5nbCAmJiB0aGlzLnNldHRpbmdzLmZsdXNoICE9PSBmYWxzZSAmJiAhcHJvcHMucDUpIHtcbiAgICAgIHByb3BzLmdsLmZsdXNoKCk7XG4gICAgfVxuICB9XG5cbiAgdGljayAoKSB7XG4gICAgaWYgKHRoaXMuc2tldGNoICYmIHR5cGVvZiB0aGlzLnNrZXRjaC50aWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aGlzLl9wcmVSZW5kZXIoKTtcbiAgICAgIHRoaXMuc2tldGNoLnRpY2sodGhpcy5wcm9wcyk7XG4gICAgICB0aGlzLl9wb3N0UmVuZGVyKCk7XG4gICAgfVxuICB9XG5cbiAgcmVuZGVyICgpIHtcbiAgICBpZiAodGhpcy5wcm9wcy5wNSkge1xuICAgICAgdGhpcy5fbGFzdFJlZHJhd1Jlc3VsdCA9IHVuZGVmaW5lZDtcbiAgICAgIHRoaXMucHJvcHMucDUucmVkcmF3KCk7XG4gICAgICByZXR1cm4gdGhpcy5fbGFzdFJlZHJhd1Jlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuc3VibWl0RHJhd0NhbGwoKTtcbiAgICB9XG4gIH1cblxuICBzdWJtaXREcmF3Q2FsbCAoKSB7XG4gICAgaWYgKCF0aGlzLnNrZXRjaCkgcmV0dXJuO1xuXG4gICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BzO1xuICAgIHRoaXMuX3ByZVJlbmRlcigpO1xuXG4gICAgbGV0IGRyYXdSZXN1bHQ7XG5cbiAgICBpZiAodHlwZW9mIHRoaXMuc2tldGNoID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBkcmF3UmVzdWx0ID0gdGhpcy5za2V0Y2gocHJvcHMpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHRoaXMuc2tldGNoLnJlbmRlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgZHJhd1Jlc3VsdCA9IHRoaXMuc2tldGNoLnJlbmRlcihwcm9wcyk7XG4gICAgfVxuXG4gICAgdGhpcy5fcG9zdFJlbmRlcigpO1xuXG4gICAgcmV0dXJuIGRyYXdSZXN1bHQ7XG4gIH1cblxuICB1cGRhdGUgKG9wdCA9IHt9KSB7XG4gICAgLy8gQ3VycmVudGx5IHVwZGF0ZSgpIGlzIG9ubHkgZm9jdXNlZCBvbiByZXNpemluZyxcbiAgICAvLyBidXQgbGF0ZXIgd2Ugd2lsbCBzdXBwb3J0IG90aGVyIG9wdGlvbnMgbGlrZSBzd2l0Y2hpbmdcbiAgICAvLyBmcmFtZXMgYW5kIHN1Y2guXG4gICAgY29uc3Qgbm90WWV0U3VwcG9ydGVkID0gW1xuICAgICAgJ2ZyYW1lJywgJ3RpbWUnLCAnZHVyYXRpb24nLFxuICAgICAgJ3RvdGFsRnJhbWVzJywgJ2ZwcycsICdwbGF5aW5nJywgJ2FuaW1hdGlvbidcbiAgICBdO1xuXG4gICAgT2JqZWN0LmtleXMob3B0KS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBpZiAobm90WWV0U3VwcG9ydGVkLmluZGV4T2Yoa2V5KSA+PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgU29ycnksIHRoZSB7ICR7a2V5fSB9IG9wdGlvbiBpcyBub3QgeWV0IHN1cHBvcnRlZCB3aXRoIHVwZGF0ZSgpLmApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY29uc3Qgb2xkQ2FudmFzID0gdGhpcy5fc2V0dGluZ3MuY2FudmFzO1xuICAgIGNvbnN0IG9sZENvbnRleHQgPSB0aGlzLl9zZXR0aW5ncy5jb250ZXh0O1xuXG4gICAgLy8gTWVyZ2UgbmV3IG9wdGlvbnMgaW50byBzZXR0aW5nc1xuICAgIGZvciAobGV0IGtleSBpbiBvcHQpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gb3B0W2tleV07XG4gICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJykgeyAvLyBpZ25vcmUgdW5kZWZpbmVkXG4gICAgICAgIHRoaXMuX3NldHRpbmdzW2tleV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBJZiBlaXRoZXIgY2FudmFzIG9yIGNvbnRleHQgaXMgY2hhbmdlZCwgd2Ugc2hvdWxkIHJlLXVwZGF0ZVxuICAgIGlmIChvbGRDYW52YXMgIT09IHRoaXMuX3NldHRpbmdzLmNhbnZhcyB8fCBvbGRDb250ZXh0ICE9PSB0aGlzLl9zZXR0aW5ncy5jb250ZXh0KSB7XG4gICAgICBjb25zdCB7IGNhbnZhcywgY29udGV4dCB9ID0gdGhpcy5fc2V0dXBDYW52YXModGhpcy5fc2V0dGluZ3MpO1xuXG4gICAgICB0aGlzLnByb3BzLmNhbnZhcyA9IGNhbnZhcztcbiAgICAgIHRoaXMucHJvcHMuY29udGV4dCA9IGNvbnRleHQ7XG5cbiAgICAgIC8vIERlbGV0ZSBvciBhZGQgYSAnZ2wnIHByb3AgZm9yIGNvbnZlbmllbmNlXG4gICAgICB0aGlzLl9zZXR1cEdMS2V5KCk7XG5cbiAgICAgIC8vIFJlLW1vdW50IHRoZSBuZXcgY2FudmFzIGlmIGl0IGhhcyBubyBwYXJlbnRcbiAgICAgIHRoaXMuX2FwcGVuZENhbnZhc0lmTmVlZGVkKCk7XG4gICAgfVxuXG4gICAgLy8gU3BlY2lhbCBjYXNlIHRvIHN1cHBvcnQgUDUuanNcbiAgICBpZiAob3B0LnA1ICYmIHR5cGVvZiBvcHQucDUgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRoaXMucHJvcHMucDUgPSBvcHQucDU7XG4gICAgICB0aGlzLnByb3BzLnA1LmRyYXcgPSAoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLl9pc1A1UmVzaXppbmcpIHJldHVybjtcbiAgICAgICAgdGhpcy5fbGFzdFJlZHJhd1Jlc3VsdCA9IHRoaXMuc3VibWl0RHJhd0NhbGwoKTtcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gRHJhdyBuZXcgZnJhbWVcbiAgICB0aGlzLnJlc2l6ZSgpO1xuICAgIHRoaXMucmVuZGVyKCk7XG4gICAgcmV0dXJuIHRoaXMucHJvcHM7XG4gIH1cblxuICBfaGFzRGltZW5zaW9ucyAoKSB7XG4gICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLnNldHRpbmdzO1xuICAgIGlmICghc2V0dGluZ3MuZGltZW5zaW9ucykgcmV0dXJuIGZhbHNlO1xuICAgIGlmICh0eXBlb2Ygc2V0dGluZ3MuZGltZW5zaW9ucyA9PT0gJ3N0cmluZycpIHJldHVybiB0cnVlO1xuICAgIGlmIChBcnJheS5pc0FycmF5KHNldHRpbmdzLmRpbWVuc2lvbnMpICYmIHNldHRpbmdzLmRpbWVuc2lvbnMubGVuZ3RoID49IDIpIHJldHVybiB0cnVlO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJlc2l6ZSAoKSB7XG4gICAgbGV0IHdpZHRoLCBoZWlnaHQ7XG4gICAgbGV0IHN0eWxlV2lkdGgsIHN0eWxlSGVpZ2h0O1xuICAgIGxldCBjYW52YXNXaWR0aCwgY2FudmFzSGVpZ2h0O1xuXG4gICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLnNldHRpbmdzO1xuXG4gICAgY29uc3QgZGltZW5zaW9ucyA9IHNldHRpbmdzLmRpbWVuc2lvbnM7XG4gICAgY29uc3QgaGFzRGltZW5zaW9ucyA9IHRoaXMuX2hhc0RpbWVuc2lvbnMoKTtcbiAgICBjb25zdCBleHBvcnRpbmcgPSB0aGlzLnByb3BzLmV4cG9ydGluZztcbiAgICBjb25zdCBzY2FsZVRvRml0ID0gaGFzRGltZW5zaW9ucyA/IHNldHRpbmdzLnNjYWxlVG9GaXQgIT09IGZhbHNlIDogZmFsc2U7XG4gICAgY29uc3Qgc2NhbGVUb1ZpZXcgPSAoIWV4cG9ydGluZyAmJiBoYXNEaW1lbnNpb25zKSA/IHNldHRpbmdzLnNjYWxlVG9WaWV3IDogdHJ1ZTtcbiAgICBjb25zdCB1bml0cyA9IHNldHRpbmdzLnVuaXRzO1xuICAgIGNvbnN0IHBpeGVsc1BlckluY2ggPSAodHlwZW9mIHNldHRpbmdzLnBpeGVsc1BlckluY2ggPT09ICdudW1iZXInICYmIGlzRmluaXRlKHNldHRpbmdzLnBpeGVsc1BlckluY2gpKSA/IHNldHRpbmdzLnBpeGVsc1BlckluY2ggOiA3MjtcbiAgICBjb25zdCBibGVlZCA9IGRlZmluZWQoc2V0dGluZ3MuYmxlZWQsIDApO1xuXG4gICAgY29uc3QgZGVmYXVsdFBpeGVsUmF0aW8gPSBpc0Jyb3dzZXIoKSA/IHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIDogMTtcbiAgICBsZXQgcGl4ZWxSYXRpbyA9IGRlZmluZWQoc2V0dGluZ3MucGl4ZWxSYXRpbywgZGVmYXVsdFBpeGVsUmF0aW8pO1xuICAgIGlmICh0eXBlb2Ygc2V0dGluZ3MubWF4UGl4ZWxSYXRpbyA9PT0gJ251bWJlcicpIHtcbiAgICAgIHBpeGVsUmF0aW8gPSBNYXRoLm1pbihzZXR0aW5ncy5tYXhQaXhlbFJhdGlvLCBwaXhlbFJhdGlvKTtcbiAgICB9XG5cbiAgICBpZiAoIXNjYWxlVG9WaWV3KSB7XG4gICAgICBwaXhlbFJhdGlvID0gMTtcbiAgICB9XG5cbiAgICBjb25zdCBkZWZhdWx0V2lkdGggPSBpc0Jyb3dzZXIoKSA/IHdpbmRvdy5pbm5lcldpZHRoIDogZGVmYXVsdE5vZGVTaXplWzBdO1xuICAgIGNvbnN0IGRlZmF1bHRIZWlnaHQgPSBpc0Jyb3dzZXIoKSA/IHdpbmRvdy5pbm5lckhlaWdodCA6IGRlZmF1bHROb2RlU2l6ZVsxXTtcbiAgICBsZXQgcGFyZW50V2lkdGggPSBkZWZhdWx0V2lkdGg7XG4gICAgbGV0IHBhcmVudEhlaWdodCA9IGRlZmF1bHRIZWlnaHQ7XG4gICAgbGV0IHRyaW1XaWR0aCwgdHJpbUhlaWdodDtcblxuICAgIC8vIFlvdSBjYW4gc3BlY2lmeSBhIGRpbWVuc2lvbnMgaW4gcGl4ZWxzIG9yIGNtL20vaW4vZXRjXG4gICAgaWYgKGhhc0RpbWVuc2lvbnMpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGdldERpbWVuc2lvbnNGcm9tUHJlc2V0KGRpbWVuc2lvbnMsIHVuaXRzLCBwaXhlbHNQZXJJbmNoKTtcbiAgICAgIGNvbnN0IGhpZ2hlc3QgPSBNYXRoLm1heChyZXN1bHRbMF0sIHJlc3VsdFsxXSk7XG4gICAgICBjb25zdCBsb3dlc3QgPSBNYXRoLm1pbihyZXN1bHRbMF0sIHJlc3VsdFsxXSk7XG4gICAgICBpZiAoc2V0dGluZ3Mub3JpZW50YXRpb24pIHtcbiAgICAgICAgY29uc3QgbGFuZHNjYXBlID0gc2V0dGluZ3Mub3JpZW50YXRpb24gPT09ICdsYW5kc2NhcGUnO1xuICAgICAgICB3aWR0aCA9IGxhbmRzY2FwZSA/IGhpZ2hlc3QgOiBsb3dlc3Q7XG4gICAgICAgIGhlaWdodCA9IGxhbmRzY2FwZSA/IGxvd2VzdCA6IGhpZ2hlc3Q7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3aWR0aCA9IHJlc3VsdFswXTtcbiAgICAgICAgaGVpZ2h0ID0gcmVzdWx0WzFdO1xuICAgICAgfVxuXG4gICAgICB0cmltV2lkdGggPSB3aWR0aDtcbiAgICAgIHRyaW1IZWlnaHQgPSBoZWlnaHQ7XG5cbiAgICAgIC8vIEFwcGx5IGJsZWVkIHdoaWNoIGlzIGFzc3VtZWQgdG8gYmUgaW4gdGhlIHNhbWUgdW5pdHNcbiAgICAgIHdpZHRoICs9IGJsZWVkICogMjtcbiAgICAgIGhlaWdodCArPSBibGVlZCAqIDI7XG4gICAgfSBlbHNlIHtcbiAgICAgIHdpZHRoID0gcGFyZW50V2lkdGg7XG4gICAgICBoZWlnaHQgPSBwYXJlbnRIZWlnaHQ7XG4gICAgICB0cmltV2lkdGggPSB3aWR0aDtcbiAgICAgIHRyaW1IZWlnaHQgPSBoZWlnaHQ7XG4gICAgfVxuXG4gICAgLy8gUmVhbCBzaXplIGluIHBpeGVscyBhZnRlciBQUEkgaXMgdGFrZW4gaW50byBhY2NvdW50XG4gICAgbGV0IHJlYWxXaWR0aCA9IHdpZHRoO1xuICAgIGxldCByZWFsSGVpZ2h0ID0gaGVpZ2h0O1xuICAgIGlmIChoYXNEaW1lbnNpb25zICYmIHVuaXRzKSB7XG4gICAgICAvLyBDb252ZXJ0IHRvIGRpZ2l0YWwvcGl4ZWwgdW5pdHMgaWYgbmVjZXNzYXJ5XG4gICAgICByZWFsV2lkdGggPSBjb252ZXJ0RGlzdGFuY2Uod2lkdGgsIHVuaXRzLCAncHgnLCBwaXhlbHNQZXJJbmNoKTtcbiAgICAgIHJlYWxIZWlnaHQgPSBjb252ZXJ0RGlzdGFuY2UoaGVpZ2h0LCB1bml0cywgJ3B4JywgcGl4ZWxzUGVySW5jaCk7XG4gICAgfVxuXG4gICAgLy8gSG93IGJpZyB0byBzZXQgdGhlICd2aWV3JyBvZiB0aGUgY2FudmFzIGluIHRoZSBicm93c2VyIChpLmUuIHN0eWxlKVxuICAgIHN0eWxlV2lkdGggPSBNYXRoLnJvdW5kKHJlYWxXaWR0aCk7XG4gICAgc3R5bGVIZWlnaHQgPSBNYXRoLnJvdW5kKHJlYWxIZWlnaHQpO1xuXG4gICAgLy8gSWYgd2Ugd2lzaCB0byBzY2FsZSB0aGUgdmlldyB0byB0aGUgYnJvd3NlciB3aW5kb3dcbiAgICBpZiAoc2NhbGVUb0ZpdCAmJiAhZXhwb3J0aW5nICYmIGhhc0RpbWVuc2lvbnMpIHtcbiAgICAgIGNvbnN0IGFzcGVjdCA9IHdpZHRoIC8gaGVpZ2h0O1xuICAgICAgY29uc3Qgd2luZG93QXNwZWN0ID0gcGFyZW50V2lkdGggLyBwYXJlbnRIZWlnaHQ7XG4gICAgICBjb25zdCBzY2FsZVRvRml0UGFkZGluZyA9IGRlZmluZWQoc2V0dGluZ3Muc2NhbGVUb0ZpdFBhZGRpbmcsIDQwKTtcbiAgICAgIGNvbnN0IG1heFdpZHRoID0gTWF0aC5yb3VuZChwYXJlbnRXaWR0aCAtIHNjYWxlVG9GaXRQYWRkaW5nICogMik7XG4gICAgICBjb25zdCBtYXhIZWlnaHQgPSBNYXRoLnJvdW5kKHBhcmVudEhlaWdodCAtIHNjYWxlVG9GaXRQYWRkaW5nICogMik7XG4gICAgICBpZiAoc3R5bGVXaWR0aCA+IG1heFdpZHRoIHx8IHN0eWxlSGVpZ2h0ID4gbWF4SGVpZ2h0KSB7XG4gICAgICAgIGlmICh3aW5kb3dBc3BlY3QgPiBhc3BlY3QpIHtcbiAgICAgICAgICBzdHlsZUhlaWdodCA9IG1heEhlaWdodDtcbiAgICAgICAgICBzdHlsZVdpZHRoID0gTWF0aC5yb3VuZChzdHlsZUhlaWdodCAqIGFzcGVjdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc3R5bGVXaWR0aCA9IG1heFdpZHRoO1xuICAgICAgICAgIHN0eWxlSGVpZ2h0ID0gTWF0aC5yb3VuZChzdHlsZVdpZHRoIC8gYXNwZWN0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIGUuZy4gQDJ4IGV4cG9ydGluZyBmb3IgUE5HIHNwcml0ZXNcbiAgICBsZXQgZXhwb3J0UGl4ZWxSYXRpbyA9IDE7XG4gICAgaWYgKGV4cG9ydGluZykge1xuICAgICAgZXhwb3J0UGl4ZWxSYXRpbyA9IGRlZmluZWQoc2V0dGluZ3MuZXhwb3J0UGl4ZWxSYXRpbywgaGFzRGltZW5zaW9ucyA/IDEgOiBwaXhlbFJhdGlvKTtcbiAgICAgIHBpeGVsUmF0aW8gPSBleHBvcnRQaXhlbFJhdGlvO1xuICAgIH1cblxuICAgIGNhbnZhc1dpZHRoID0gc2NhbGVUb1ZpZXcgPyBNYXRoLnJvdW5kKHBpeGVsUmF0aW8gKiBzdHlsZVdpZHRoKSA6IE1hdGgucm91bmQoZXhwb3J0UGl4ZWxSYXRpbyAqIHJlYWxXaWR0aCk7XG4gICAgY2FudmFzSGVpZ2h0ID0gc2NhbGVUb1ZpZXcgPyBNYXRoLnJvdW5kKHBpeGVsUmF0aW8gKiBzdHlsZUhlaWdodCkgOiBNYXRoLnJvdW5kKGV4cG9ydFBpeGVsUmF0aW8gKiByZWFsSGVpZ2h0KTtcblxuICAgIGNvbnN0IHZpZXdwb3J0V2lkdGggPSBzY2FsZVRvVmlldyA/IE1hdGgucm91bmQoc3R5bGVXaWR0aCkgOiBNYXRoLnJvdW5kKHJlYWxXaWR0aCk7XG4gICAgY29uc3Qgdmlld3BvcnRIZWlnaHQgPSBzY2FsZVRvVmlldyA/IE1hdGgucm91bmQoc3R5bGVIZWlnaHQpIDogTWF0aC5yb3VuZChyZWFsSGVpZ2h0KTtcblxuICAgIGNvbnN0IHNjYWxlWCA9IGNhbnZhc1dpZHRoIC8gd2lkdGg7XG4gICAgY29uc3Qgc2NhbGVZID0gY2FudmFzSGVpZ2h0IC8gaGVpZ2h0O1xuXG4gICAgLy8gQXNzaWduIHRvIGN1cnJlbnQgcHJvcHNcbiAgICBPYmplY3QuYXNzaWduKHRoaXMuX3Byb3BzLCB7XG4gICAgICBibGVlZCxcbiAgICAgIHBpeGVsUmF0aW8sXG4gICAgICB3aWR0aCxcbiAgICAgIGhlaWdodCxcbiAgICAgIHNjYWxlWCxcbiAgICAgIHNjYWxlWSxcbiAgICAgIHZpZXdwb3J0V2lkdGgsXG4gICAgICB2aWV3cG9ydEhlaWdodCxcbiAgICAgIGNhbnZhc1dpZHRoLFxuICAgICAgY2FudmFzSGVpZ2h0LFxuICAgICAgdHJpbVdpZHRoLFxuICAgICAgdHJpbUhlaWdodCxcbiAgICAgIHN0eWxlV2lkdGgsXG4gICAgICBzdHlsZUhlaWdodFxuICAgIH0pO1xuXG4gICAgLy8gVXBkYXRlIGNhbnZhcyBzZXR0aW5nc1xuICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMucHJvcHMuY2FudmFzO1xuICAgIGlmIChjYW52YXMgJiYgc2V0dGluZ3MucmVzaXplQ2FudmFzICE9PSBmYWxzZSkge1xuICAgICAgaWYgKHRoaXMucHJvcHMucDUpIHtcbiAgICAgICAgLy8gUDUuanMgc3BlY2lmaWMgZWRnZSBjYXNlXG4gICAgICAgIGlmIChjYW52YXMud2lkdGggIT09IGNhbnZhc1dpZHRoIHx8IGNhbnZhcy5oZWlnaHQgIT09IGNhbnZhc0hlaWdodCkge1xuICAgICAgICAgIHRoaXMuX2lzUDVSZXNpemluZyA9IHRydWU7XG4gICAgICAgICAgLy8gVGhpcyBjYXVzZXMgYSByZS1kcmF3IDpcXCBzbyB3ZSBpZ25vcmUgZHJhd3MgaW4gdGhlIG1lYW4gdGltZS4uLiBzb3J0YSBoYWNreVxuICAgICAgICAgIHRoaXMucHJvcHMucDUucGl4ZWxEZW5zaXR5KHBpeGVsUmF0aW8pO1xuICAgICAgICAgIHRoaXMucHJvcHMucDUucmVzaXplQ2FudmFzKGNhbnZhc1dpZHRoIC8gcGl4ZWxSYXRpbywgY2FudmFzSGVpZ2h0IC8gcGl4ZWxSYXRpbywgZmFsc2UpO1xuICAgICAgICAgIHRoaXMuX2lzUDVSZXNpemluZyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBGb3JjZSBjYW52YXMgc2l6ZVxuICAgICAgICBpZiAoY2FudmFzLndpZHRoICE9PSBjYW52YXNXaWR0aCkgY2FudmFzLndpZHRoID0gY2FudmFzV2lkdGg7XG4gICAgICAgIGlmIChjYW52YXMuaGVpZ2h0ICE9PSBjYW52YXNIZWlnaHQpIGNhbnZhcy5oZWlnaHQgPSBjYW52YXNIZWlnaHQ7XG4gICAgICB9XG4gICAgICAvLyBVcGRhdGUgY2FudmFzIHN0eWxlXG4gICAgICBpZiAoaXNCcm93c2VyKCkpIHtcbiAgICAgICAgY2FudmFzLnN0eWxlLndpZHRoID0gYCR7c3R5bGVXaWR0aH1weGA7XG4gICAgICAgIGNhbnZhcy5zdHlsZS5oZWlnaHQgPSBgJHtzdHlsZUhlaWdodH1weGA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU2VuZCByZXNpemUgZXZlbnQgdG8gc2tldGNoXG4gICAgaWYgKHRoaXMuc2tldGNoICYmIHR5cGVvZiB0aGlzLnNrZXRjaC5yZXNpemUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRoaXMuc2tldGNoLnJlc2l6ZSh0aGlzLnByb3BzKTtcbiAgICB9XG4gIH1cblxuICBhbmltYXRlICgpIHtcbiAgICBpZiAoIXRoaXMucHJvcHMucGxheWluZykgcmV0dXJuO1xuICAgIGlmICghaXNCcm93c2VyKCkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1tjYW52YXMtc2tldGNoXSBXQVJOOiBBbmltYXRpb24gaW4gTm9kZS5qcyBpcyBub3QgeWV0IHN1cHBvcnRlZCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLl9yYWYgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuX2FuaW1hdGVIYW5kbGVyKTtcblxuICAgIGxldCBub3cgPSByaWdodE5vdygpO1xuXG4gICAgY29uc3QgZnBzID0gdGhpcy5wcm9wcy5mcHM7XG4gICAgY29uc3QgZnJhbWVJbnRlcnZhbE1TID0gMTAwMCAvIGZwcztcbiAgICBsZXQgZGVsdGFUaW1lTVMgPSBub3cgLSB0aGlzLl9sYXN0VGltZTtcblxuICAgIGNvbnN0IGR1cmF0aW9uID0gdGhpcy5wcm9wcy5kdXJhdGlvbjtcbiAgICBjb25zdCBoYXNEdXJhdGlvbiA9IHR5cGVvZiBkdXJhdGlvbiA9PT0gJ251bWJlcicgJiYgaXNGaW5pdGUoZHVyYXRpb24pO1xuXG4gICAgbGV0IGlzTmV3RnJhbWUgPSB0cnVlO1xuICAgIGNvbnN0IHBsYXliYWNrUmF0ZSA9IHRoaXMuc2V0dGluZ3MucGxheWJhY2tSYXRlO1xuICAgIGlmIChwbGF5YmFja1JhdGUgPT09ICdmaXhlZCcpIHtcbiAgICAgIGRlbHRhVGltZU1TID0gZnJhbWVJbnRlcnZhbE1TO1xuICAgIH0gZWxzZSBpZiAocGxheWJhY2tSYXRlID09PSAndGhyb3R0bGUnKSB7XG4gICAgICBpZiAoZGVsdGFUaW1lTVMgPiBmcmFtZUludGVydmFsTVMpIHtcbiAgICAgICAgbm93ID0gbm93IC0gKGRlbHRhVGltZU1TICUgZnJhbWVJbnRlcnZhbE1TKTtcbiAgICAgICAgdGhpcy5fbGFzdFRpbWUgPSBub3c7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpc05ld0ZyYW1lID0gZmFsc2U7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2xhc3RUaW1lID0gbm93O1xuICAgIH1cblxuICAgIGNvbnN0IGRlbHRhVGltZSA9IGRlbHRhVGltZU1TIC8gMTAwMDtcbiAgICBsZXQgbmV3VGltZSA9IHRoaXMucHJvcHMudGltZSArIGRlbHRhVGltZSAqIHRoaXMucHJvcHMudGltZVNjYWxlO1xuXG4gICAgLy8gSGFuZGxlIHJldmVyc2UgdGltZSBzY2FsZVxuICAgIGlmIChuZXdUaW1lIDwgMCAmJiBoYXNEdXJhdGlvbikge1xuICAgICAgbmV3VGltZSA9IGR1cmF0aW9uICsgbmV3VGltZTtcbiAgICB9XG5cbiAgICAvLyBSZS1zdGFydCBhbmltYXRpb25cbiAgICBsZXQgaXNGaW5pc2hlZCA9IGZhbHNlO1xuICAgIGxldCBpc0xvb3BTdGFydCA9IGZhbHNlO1xuXG4gICAgY29uc3QgbG9vcGluZyA9IHRoaXMuc2V0dGluZ3MubG9vcCAhPT0gZmFsc2U7XG4gICAgaWYgKGhhc0R1cmF0aW9uICYmIG5ld1RpbWUgPj0gZHVyYXRpb24pIHtcbiAgICAgIC8vIFJlLXN0YXJ0IGFuaW1hdGlvblxuICAgICAgaWYgKGxvb3BpbmcpIHtcbiAgICAgICAgaXNOZXdGcmFtZSA9IHRydWU7XG4gICAgICAgIG5ld1RpbWUgPSBuZXdUaW1lICUgZHVyYXRpb247XG4gICAgICAgIGlzTG9vcFN0YXJ0ID0gdHJ1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlzTmV3RnJhbWUgPSBmYWxzZTtcbiAgICAgICAgbmV3VGltZSA9IGR1cmF0aW9uO1xuICAgICAgICBpc0ZpbmlzaGVkID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fc2lnbmFsRW5kKCk7XG4gICAgfVxuXG4gICAgaWYgKGlzTmV3RnJhbWUpIHtcbiAgICAgIHRoaXMucHJvcHMuZGVsdGFUaW1lID0gZGVsdGFUaW1lO1xuICAgICAgdGhpcy5wcm9wcy50aW1lID0gbmV3VGltZTtcbiAgICAgIHRoaXMucHJvcHMucGxheWhlYWQgPSB0aGlzLl9jb21wdXRlUGxheWhlYWQobmV3VGltZSwgZHVyYXRpb24pO1xuICAgICAgY29uc3QgbGFzdEZyYW1lID0gdGhpcy5wcm9wcy5mcmFtZTtcbiAgICAgIHRoaXMucHJvcHMuZnJhbWUgPSB0aGlzLl9jb21wdXRlQ3VycmVudEZyYW1lKCk7XG4gICAgICBpZiAoaXNMb29wU3RhcnQpIHRoaXMuX3NpZ25hbEJlZ2luKCk7XG4gICAgICBpZiAobGFzdEZyYW1lICE9PSB0aGlzLnByb3BzLmZyYW1lKSB0aGlzLnRpY2soKTtcbiAgICAgIHRoaXMucmVuZGVyKCk7XG4gICAgICB0aGlzLnByb3BzLmRlbHRhVGltZSA9IDA7XG4gICAgfVxuXG4gICAgaWYgKGlzRmluaXNoZWQpIHtcbiAgICAgIHRoaXMucGF1c2UoKTtcbiAgICB9XG4gIH1cblxuICBtb3VudCAoKSB7XG4gICAgdGhpcy5fYXBwZW5kQ2FudmFzSWZOZWVkZWQoKTtcbiAgfVxuXG4gIHVubW91bnQgKCkge1xuICAgIGlmIChpc0Jyb3dzZXIoKSkge1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMuX3Jlc2l6ZUhhbmRsZXIpO1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLl9leHBvcnRIYW5kbGVyKTtcbiAgICB9XG4gIH1cblxuICBfYXBwZW5kQ2FudmFzSWZOZWVkZWQgKCkge1xuICAgIGlmICghaXNCcm93c2VyKCkpIHJldHVybjtcbiAgICBpZiAodGhpcy5wcm9wcy5jYW52YXMgJiYgIXRoaXMucHJvcHMuY2FudmFzLnBhcmVudEVsZW1lbnQpIHtcbiAgICAgIC8vIEF0IHNvbWUgcG9pbnQgd2UgY2FuIGxldCB0aGlzIGJlIGNvbmZpZ3VyYWJsZS4uLlxuICAgICAgY29uc3QgZGVmYXVsdFBhcmVudCA9IGRvY3VtZW50LmJvZHk7XG4gICAgICBkZWZhdWx0UGFyZW50LmFwcGVuZENoaWxkKHRoaXMucHJvcHMuY2FudmFzKTtcbiAgICB9XG4gIH1cblxuICBfY3JlYXRlQ2FudmFzICgpIHtcbiAgICBpZiAoIWlzQnJvd3NlcigpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0l0IGFwcGVhcnMgeW91IGFyZSBydW5pbmcgZnJvbSBOb2RlLmpzIG9yIGEgbm9uLWJyb3dzZXIgZW52aXJvbm1lbnQuIFRyeSBwYXNzaW5nIGluIGFuIGV4aXN0aW5nIHsgY2FudmFzIH0gaW50ZXJmYWNlIGluc3RlYWQuJyk7XG4gICAgfVxuICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgfVxuXG4gIF9zZXR1cENhbnZhcyAoc2V0dGluZ3MpIHtcbiAgICBsZXQgY29udGV4dCwgY2FudmFzO1xuICAgIGlmIChzZXR0aW5ncy5jYW52YXMgIT09IGZhbHNlKSB7XG4gICAgICAvLyBEZXRlcm1pbmUgdGhlIGNhbnZhcyBhbmQgY29udGV4dCB0byBjcmVhdGVcbiAgICAgIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0O1xuICAgICAgaWYgKCFjb250ZXh0IHx8IHR5cGVvZiBjb250ZXh0ID09PSAnc3RyaW5nJykge1xuICAgICAgICBjb25zdCBuZXdDYW52YXMgPSBzZXR0aW5ncy5jYW52YXMgfHwgdGhpcy5fY3JlYXRlQ2FudmFzKCk7XG4gICAgICAgIGNvbnN0IHR5cGUgPSBjb250ZXh0IHx8ICcyZCc7XG4gICAgICAgIGNvbnRleHQgPSBnZXRDYW52YXNDb250ZXh0KHR5cGUsIGFzc2lnbih7fSwgc2V0dGluZ3MuYXR0cmlidXRlcywgeyBjYW52YXM6IG5ld0NhbnZhcyB9KSk7XG4gICAgICAgIGlmICghY29udGV4dCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIGF0IGNhbnZhcy5nZXRDb250ZXh0KCcke3R5cGV9JykgLSB0aGUgYnJvd3NlciBtYXkgbm90IHN1cHBvcnQgdGhpcyBjb250ZXh0LCBvciBhIGRpZmZlcmVudCBjb250ZXh0IG1heSBhbHJlYWR5IGJlIGluIHVzZSB3aXRoIHRoaXMgY2FudmFzLmApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGNhbnZhcyA9IGNvbnRleHQuY2FudmFzO1xuICAgICAgLy8gRW5zdXJlIGNvbnRleHQgbWF0Y2hlcyB1c2VyJ3MgY2FudmFzIGV4cGVjdGF0aW9uc1xuICAgICAgaWYgKHNldHRpbmdzLmNhbnZhcyAmJiBjYW52YXMgIT09IHNldHRpbmdzLmNhbnZhcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSB7IGNhbnZhcyB9IGFuZCB7IGNvbnRleHQgfSBzZXR0aW5ncyBtdXN0IHBvaW50IHRvIHRoZSBzYW1lIHVuZGVybHlpbmcgY2FudmFzIGVsZW1lbnQnKTtcbiAgICAgIH1cblxuICAgICAgLy8gQXBwbHkgcGl4ZWxhdGlvbiB0byBjYW52YXMgaWYgbmVjZXNzYXJ5LCB0aGlzIGlzIG1vc3RseSBhIGNvbnZlbmllbmNlIHV0aWxpdHlcbiAgICAgIGlmIChzZXR0aW5ncy5waXhlbGF0ZWQpIHtcbiAgICAgICAgY29udGV4dC5pbWFnZVNtb290aGluZ0VuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgY29udGV4dC5tb3pJbWFnZVNtb290aGluZ0VuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgY29udGV4dC5vSW1hZ2VTbW9vdGhpbmdFbmFibGVkID0gZmFsc2U7XG4gICAgICAgIGNvbnRleHQud2Via2l0SW1hZ2VTbW9vdGhpbmdFbmFibGVkID0gZmFsc2U7XG4gICAgICAgIGNvbnRleHQubXNJbWFnZVNtb290aGluZ0VuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgY2FudmFzLnN0eWxlWydpbWFnZS1yZW5kZXJpbmcnXSA9ICdwaXhlbGF0ZWQnO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4geyBjYW52YXMsIGNvbnRleHQgfTtcbiAgfVxuXG4gIF9zZXR1cEdMS2V5ICgpIHtcbiAgICBpZiAodGhpcy5wcm9wcy5jb250ZXh0KSB7XG4gICAgICBpZiAoaXNXZWJHTENvbnRleHQodGhpcy5wcm9wcy5jb250ZXh0KSkge1xuICAgICAgICB0aGlzLl9wcm9wcy5nbCA9IHRoaXMucHJvcHMuY29udGV4dDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9wcm9wcy5nbDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzZXR1cCAoc2V0dGluZ3MgPSB7fSkge1xuICAgIGlmICh0aGlzLnNrZXRjaCkgdGhyb3cgbmV3IEVycm9yKCdNdWx0aXBsZSBzZXR1cCgpIGNhbGxzIG5vdCB5ZXQgc3VwcG9ydGVkLicpO1xuXG4gICAgdGhpcy5fc2V0dGluZ3MgPSBPYmplY3QuYXNzaWduKHt9LCBzZXR0aW5ncywgdGhpcy5fc2V0dGluZ3MpO1xuXG4gICAgLy8gR2V0IGluaXRpYWwgY2FudmFzICYgY29udGV4dFxuICAgIGNvbnN0IHsgY29udGV4dCwgY2FudmFzIH0gPSB0aGlzLl9zZXR1cENhbnZhcyh0aGlzLl9zZXR0aW5ncyk7XG5cbiAgICAvLyBHZXQgdGltaW5nIGRhdGFcbiAgICBsZXQgZHVyYXRpb24gPSBzZXR0aW5ncy5kdXJhdGlvbjtcbiAgICBsZXQgdG90YWxGcmFtZXMgPSBzZXR0aW5ncy50b3RhbEZyYW1lcztcbiAgICBjb25zdCB0aW1lU2NhbGUgPSBkZWZpbmVkKHNldHRpbmdzLnRpbWVTY2FsZSwgMSk7XG4gICAgY29uc3QgZnBzID0gZGVmaW5lZChzZXR0aW5ncy5mcHMsIDMwKTtcbiAgICBjb25zdCBoYXNEdXJhdGlvbiA9IHR5cGVvZiBkdXJhdGlvbiA9PT0gJ251bWJlcicgJiYgaXNGaW5pdGUoZHVyYXRpb24pO1xuICAgIGNvbnN0IGhhc1RvdGFsRnJhbWVzID0gdHlwZW9mIHRvdGFsRnJhbWVzID09PSAnbnVtYmVyJyAmJiBpc0Zpbml0ZSh0b3RhbEZyYW1lcyk7XG5cbiAgICBjb25zdCB0b3RhbEZyYW1lc0Zyb21EdXJhdGlvbiA9IGhhc0R1cmF0aW9uID8gTWF0aC5mbG9vcihmcHMgKiBkdXJhdGlvbikgOiB1bmRlZmluZWQ7XG4gICAgY29uc3QgZHVyYXRpb25Gcm9tVG90YWxGcmFtZXMgPSBoYXNUb3RhbEZyYW1lcyA/ICh0b3RhbEZyYW1lcyAvIGZwcykgOiB1bmRlZmluZWQ7XG4gICAgaWYgKGhhc0R1cmF0aW9uICYmIGhhc1RvdGFsRnJhbWVzICYmIHRvdGFsRnJhbWVzRnJvbUR1cmF0aW9uICE9PSB0b3RhbEZyYW1lcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdZb3Ugc2hvdWxkIHNwZWNpZnkgZWl0aGVyIGR1cmF0aW9uIG9yIHRvdGFsRnJhbWVzLCBidXQgbm90IGJvdGguIE9yLCB0aGV5IG11c3QgbWF0Y2ggZXhhY3RseS4nKTtcbiAgICB9XG5cbiAgICB0b3RhbEZyYW1lcyA9IGRlZmluZWQodG90YWxGcmFtZXMsIHRvdGFsRnJhbWVzRnJvbUR1cmF0aW9uLCBJbmZpbml0eSk7XG4gICAgZHVyYXRpb24gPSBkZWZpbmVkKGR1cmF0aW9uLCBkdXJhdGlvbkZyb21Ub3RhbEZyYW1lcywgSW5maW5pdHkpO1xuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gc2V0dGluZ3MudGltZTtcbiAgICBjb25zdCBzdGFydEZyYW1lID0gc2V0dGluZ3MuZnJhbWU7XG4gICAgY29uc3QgaGFzU3RhcnRUaW1lID0gdHlwZW9mIHN0YXJ0VGltZSA9PT0gJ251bWJlcicgJiYgaXNGaW5pdGUoc3RhcnRUaW1lKTtcbiAgICBjb25zdCBoYXNTdGFydEZyYW1lID0gdHlwZW9mIHN0YXJ0RnJhbWUgPT09ICdudW1iZXInICYmIGlzRmluaXRlKHN0YXJ0RnJhbWUpO1xuXG4gICAgLy8gc3RhcnQgYXQgemVybyB1bmxlc3MgdXNlciBzcGVjaWZpZXMgZnJhbWUgb3IgdGltZSAoYnV0IG5vdCBib3RoIG1pc21hdGNoZWQpXG4gICAgbGV0IHRpbWUgPSAwO1xuICAgIGxldCBmcmFtZSA9IDA7XG4gICAgbGV0IHBsYXloZWFkID0gMDtcbiAgICBpZiAoaGFzU3RhcnRUaW1lICYmIGhhc1N0YXJ0RnJhbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignWW91IHNob3VsZCBzcGVjaWZ5IGVpdGhlciBzdGFydCBmcmFtZSBvciB0aW1lLCBidXQgbm90IGJvdGguJyk7XG4gICAgfSBlbHNlIGlmIChoYXNTdGFydFRpbWUpIHtcbiAgICAgIC8vIFVzZXIgc3BlY2lmaWVzIHRpbWUsIHdlIGluZmVyIGZyYW1lcyBmcm9tIEZQU1xuICAgICAgdGltZSA9IHN0YXJ0VGltZTtcbiAgICAgIHBsYXloZWFkID0gdGhpcy5fY29tcHV0ZVBsYXloZWFkKHRpbWUsIGR1cmF0aW9uKTtcbiAgICAgIGZyYW1lID0gdGhpcy5fY29tcHV0ZUZyYW1lKFxuICAgICAgICBwbGF5aGVhZCwgdGltZSxcbiAgICAgICAgdG90YWxGcmFtZXMsIGZwc1xuICAgICAgKTtcbiAgICB9IGVsc2UgaWYgKGhhc1N0YXJ0RnJhbWUpIHtcbiAgICAgIC8vIFVzZXIgc3BlY2lmaWVzIGZyYW1lIG51bWJlciwgd2UgaW5mZXIgdGltZSBmcm9tIEZQU1xuICAgICAgZnJhbWUgPSBzdGFydEZyYW1lO1xuICAgICAgdGltZSA9IGZyYW1lIC8gZnBzO1xuICAgICAgcGxheWhlYWQgPSB0aGlzLl9jb21wdXRlUGxheWhlYWQodGltZSwgZHVyYXRpb24pO1xuICAgIH1cblxuICAgIC8vIEluaXRpYWwgcmVuZGVyIHN0YXRlIGZlYXR1cmVzXG4gICAgdGhpcy5fcHJvcHMgPSB7XG4gICAgICBjYW52YXMsXG4gICAgICBjb250ZXh0LFxuICAgICAgZnBzLFxuICAgICAgZnJhbWUsXG4gICAgICB0aW1lLFxuICAgICAgZGVsdGFUaW1lOiAwLFxuICAgICAgcGxheWhlYWQsXG4gICAgICBkdXJhdGlvbixcbiAgICAgIHN0YXJ0ZWQ6IGZhbHNlLFxuICAgICAgZXhwb3J0aW5nOiBmYWxzZSxcbiAgICAgIHBsYXlpbmc6IGZhbHNlLFxuICAgICAgcmVjb3JkaW5nOiBmYWxzZSxcbiAgICAgIHRvdGFsRnJhbWVzLFxuICAgICAgdGltZVNjYWxlLFxuICAgICAgc2V0dGluZ3M6IHRoaXMuc2V0dGluZ3MsXG5cbiAgICAgIC8vIEV4cG9ydCBzb21lIHNwZWNpZmljIGFjdGlvbnMgdG8gdGhlIHNrZXRjaFxuICAgICAgcmVuZGVyOiAoKSA9PiB0aGlzLnJlbmRlcigpLFxuICAgICAgdGljazogKCkgPT4gdGhpcy50aWNrKCksXG4gICAgICByZXNpemU6ICgpID0+IHRoaXMucmVzaXplKCksXG4gICAgICB1cGRhdGU6IChvcHQpID0+IHRoaXMudXBkYXRlKG9wdCksXG4gICAgICBleHBvcnRGcmFtZTogb3B0ID0+IHRoaXMuZXhwb3J0RnJhbWUob3B0KSxcbiAgICAgIHJlY29yZDogKCkgPT4gdGhpcy5yZWNvcmQoKSxcbiAgICAgIHBsYXk6ICgpID0+IHRoaXMucGxheSgpLFxuICAgICAgcGF1c2U6ICgpID0+IHRoaXMucGF1c2UoKSxcbiAgICAgIHN0b3A6ICgpID0+IHRoaXMuc3RvcCgpXG4gICAgfTtcblxuICAgIC8vIEZvciBXZWJHTCBza2V0Y2hlcywgYSBnbCB2YXJpYWJsZSByZWFkcyBhIGJpdCBiZXR0ZXJcbiAgICB0aGlzLl9zZXR1cEdMS2V5KCk7XG5cbiAgICAvLyBUcmlnZ2VyIGluaXRpYWwgcmVzaXplIG5vdyBzbyB0aGF0IGNhbnZhcyBpcyBhbHJlYWR5IHNpemVkXG4gICAgLy8gYnkgdGhlIHRpbWUgd2UgbG9hZCB0aGUgc2tldGNoXG4gICAgdGhpcy5yZXNpemUoKTtcbiAgfVxuXG4gIGxvYWQgKGNyZWF0ZVNrZXRjaCkge1xuICAgIC8vIFVzZXIgZGlkbid0IHNwZWNpZnkgYSBmdW5jdGlvblxuICAgIGlmICh0eXBlb2YgY3JlYXRlU2tldGNoICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBmdW5jdGlvbiBtdXN0IHRha2UgaW4gYSBmdW5jdGlvbiBhcyB0aGUgZmlyc3QgcGFyYW1ldGVyLiBFeGFtcGxlOlxcbiAgY2FudmFzU2tldGNoZXIoKCkgPT4geyAuLi4gfSwgc2V0dGluZ3MpJyk7XG4gICAgfVxuXG4gICAgLy8gVGhpcyBpcyBhIGJpdCBvZiBhIHRyaWNreSBjYXNlOyB3ZSBzZXQgdXAgdGhlIGF1dG8tc2NhbGluZyBoZXJlXG4gICAgLy8gaW4gY2FzZSB0aGUgdXNlciBkZWNpZGVzIHRvIHJlbmRlciBhbnl0aGluZyB0byB0aGUgY29udGV4dCAqYmVmb3JlKiB0aGVcbiAgICAvLyByZW5kZXIoKSBmdW5jdGlvbi4uLiBIb3dldmVyLCB1c2VycyBzaG91bGQgaW5zdGVhZCB1c2UgYmVnaW4oKSBmdW5jdGlvbiBmb3IgdGhhdC5cbiAgICB0aGlzLl9wcmVSZW5kZXIoKTtcblxuICAgIGxldCBwcmVsb2FkID0gUHJvbWlzZS5yZXNvbHZlKCk7XG5cbiAgICAvLyBCZWNhdXNlIG9mIFA1LmpzJ3MgdW51c3VhbCBzdHJ1Y3R1cmUsIHdlIGhhdmUgdG8gZG8gYSBiaXQgb2ZcbiAgICAvLyBsaWJyYXJ5LXNwZWNpZmljIGNoYW5nZXMgdG8gc3VwcG9ydCBpdCBwcm9wZXJseS5cbiAgICBpZiAodGhpcy5zZXR0aW5ncy5wNSkge1xuICAgICAgaWYgKCFpc0Jyb3dzZXIoKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tjYW52YXMtc2tldGNoXSBFUlJPUjogVXNpbmcgcDUuanMgaW4gTm9kZS5qcyBpcyBub3Qgc3VwcG9ydGVkJyk7XG4gICAgICB9XG4gICAgICBwcmVsb2FkID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgIGxldCBQNUNvbnN0cnVjdG9yID0gdGhpcy5zZXR0aW5ncy5wNTtcbiAgICAgICAgbGV0IHByZWxvYWQ7XG4gICAgICAgIGlmIChQNUNvbnN0cnVjdG9yLnA1KSB7XG4gICAgICAgICAgcHJlbG9hZCA9IFA1Q29uc3RydWN0b3IucHJlbG9hZDtcbiAgICAgICAgICBQNUNvbnN0cnVjdG9yID0gUDVDb25zdHJ1Y3Rvci5wNTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRoZSBza2V0Y2ggc2V0dXA7IGRpc2FibGUgbG9vcCwgc2V0IHNpemluZywgZXRjLlxuICAgICAgICBjb25zdCBwNVNrZXRjaCA9IHA1ID0+IHtcbiAgICAgICAgICAvLyBIb29rIGluIHByZWxvYWQgaWYgbmVjZXNzYXJ5XG4gICAgICAgICAgaWYgKHByZWxvYWQpIHA1LnByZWxvYWQgPSAoKSA9PiBwcmVsb2FkKHA1KTtcbiAgICAgICAgICBwNS5zZXR1cCA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHByb3BzID0gdGhpcy5wcm9wcztcbiAgICAgICAgICAgIGNvbnN0IGlzR0wgPSB0aGlzLnNldHRpbmdzLmNvbnRleHQgPT09ICd3ZWJnbCc7XG4gICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IGlzR0wgPyBwNS5XRUJHTCA6IHA1LlAyRDtcbiAgICAgICAgICAgIHA1Lm5vTG9vcCgpO1xuICAgICAgICAgICAgcDUucGl4ZWxEZW5zaXR5KHByb3BzLnBpeGVsUmF0aW8pO1xuICAgICAgICAgICAgcDUuY3JlYXRlQ2FudmFzKHByb3BzLnZpZXdwb3J0V2lkdGgsIHByb3BzLnZpZXdwb3J0SGVpZ2h0LCByZW5kZXJlcik7XG4gICAgICAgICAgICBpZiAoaXNHTCAmJiB0aGlzLnNldHRpbmdzLmF0dHJpYnV0ZXMpIHtcbiAgICAgICAgICAgICAgcDUuc2V0QXR0cmlidXRlcyh0aGlzLnNldHRpbmdzLmF0dHJpYnV0ZXMpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLnVwZGF0ZSh7IHA1LCBjYW52YXM6IHA1LmNhbnZhcywgY29udGV4dDogcDUuX3JlbmRlcmVyLmRyYXdpbmdDb250ZXh0IH0pO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH07XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gU3VwcG9ydCBnbG9iYWwgYW5kIGluc3RhbmNlIFA1LmpzIG1vZGVzXG4gICAgICAgIGlmICh0eXBlb2YgUDVDb25zdHJ1Y3RvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIG5ldyBQNUNvbnN0cnVjdG9yKHA1U2tldGNoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAodHlwZW9mIHdpbmRvdy5jcmVhdGVDYW52YXMgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcInsgcDUgfSBzZXR0aW5nIGlzIHBhc3NlZCBidXQgY2FuJ3QgZmluZCBwNS5qcyBpbiBnbG9iYWwgKHdpbmRvdykgc2NvcGUuIE1heWJlIHlvdSBkaWQgbm90IGNyZWF0ZSBpdCBnbG9iYWxseT9cXG5uZXcgcDUoKTsgLy8gPC0tIGF0dGFjaGVzIHRvIGdsb2JhbCBzY29wZVwiKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcDVTa2V0Y2god2luZG93KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHByZWxvYWQudGhlbigoKSA9PiB7XG4gICAgICAvLyBMb2FkIHRoZSB1c2VyJ3Mgc2tldGNoXG4gICAgICBsZXQgbG9hZGVyID0gY3JlYXRlU2tldGNoKHRoaXMucHJvcHMpO1xuICAgICAgaWYgKCFpc1Byb21pc2UobG9hZGVyKSkge1xuICAgICAgICBsb2FkZXIgPSBQcm9taXNlLnJlc29sdmUobG9hZGVyKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBsb2FkZXI7XG4gICAgfSkudGhlbihza2V0Y2ggPT4ge1xuICAgICAgaWYgKCFza2V0Y2gpIHNrZXRjaCA9IHt9O1xuICAgICAgdGhpcy5fc2tldGNoID0gc2tldGNoO1xuXG4gICAgICAvLyBPbmNlIHRoZSBza2V0Y2ggaXMgbG9hZGVkIHdlIGNhbiBhZGQgdGhlIGV2ZW50c1xuICAgICAgaWYgKGlzQnJvd3NlcigpKSB7XG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5fZXhwb3J0SGFuZGxlcik7XG4gICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCB0aGlzLl9yZXNpemVIYW5kbGVyKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fcG9zdFJlbmRlcigpO1xuXG4gICAgICAvLyBTZW5kIGFuIGluaXRpYWwgJ3Jlc2l6ZScgZXZlbnQgbm93IHRoYXQgdGhlIHNrZXRjaFxuICAgICAgLy8gaGFzIGJlZW4gY29uZmlndXJlZCBhbmQgbG9hZGVkXG4gICAgICBpZiAodHlwZW9mIHRoaXMuX3NrZXRjaC5yZXNpemUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgdGhpcy5za2V0Y2gucmVzaXplKHRoaXMucHJvcHMpO1xuICAgICAgfVxuICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICBjb25zb2xlLndhcm4oJ0NvdWxkIG5vdCBzdGFydCBza2V0Y2gsIHRoZSBhc3luYyBsb2FkaW5nIGZ1bmN0aW9uIHJlamVjdGVkIHdpdGggYW4gZXJyb3I6XFxuICAgIEVycm9yOiAnICsgZXJyLm1lc3NhZ2UpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH0pO1xuICB9XG59XG5cbmV4cG9ydCB7IGRlZmF1bHQgYXMgUGFwZXJTaXplIH0gZnJvbSAnLi9wYXBlci1zaXplcyc7XG5cbmZ1bmN0aW9uIGNhbnZhc1NrZXRjaCAoc2tldGNoLCBzZXR0aW5ncyA9IHt9KSB7XG4gIGlmIChzZXR0aW5ncy5wNSkge1xuICAgIGlmIChzZXR0aW5ncy5jYW52YXMgfHwgKHNldHRpbmdzLmNvbnRleHQgJiYgdHlwZW9mIHNldHRpbmdzLmNvbnRleHQgIT09ICdzdHJpbmcnKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbiB7IHA1IH0gbW9kZSwgeW91IGNhbid0IHBhc3MgeW91ciBvd24gY2FudmFzIG9yIGNvbnRleHQsIHVubGVzcyB0aGUgY29udGV4dCBpcyBhIFwid2ViZ2xcIiBvciBcIjJkXCIgc3RyaW5nYCk7XG4gICAgfVxuXG4gICAgLy8gRG8gbm90IGNyZWF0ZSBhIGNhbnZhcyBvbiBzdGFydHVwLCBzaW5jZSBQNS5qcyBkb2VzIHRoYXQgZm9yIHVzXG4gICAgY29uc3QgY29udGV4dCA9IHR5cGVvZiBzZXR0aW5ncy5jb250ZXh0ID09PSAnc3RyaW5nJyA/IHNldHRpbmdzLmNvbnRleHQgOiBmYWxzZTtcbiAgICBzZXR0aW5ncyA9IE9iamVjdC5hc3NpZ24oe30sIHNldHRpbmdzLCB7IGNhbnZhczogZmFsc2UsIGNvbnRleHQgfSk7XG4gIH1cblxuICBjb25zdCBtYW5hZ2VyID0gbmV3IFNrZXRjaE1hbmFnZXIoKTtcbiAgaWYgKHNrZXRjaCkge1xuICAgIC8vIEFwcGx5IHNldHRpbmdzIGFuZCBjcmVhdGUgYSBjYW52YXNcbiAgICBtYW5hZ2VyLnNldHVwKHNldHRpbmdzKTtcbiAgICAvLyBNb3VudCB0aGUgc2tldGNoIHRvIGl0cyBwYXJlbnQgZWxlbWVudCAob3IgZG9jdW1lbnQuYm9keSlcbiAgICBtYW5hZ2VyLm1vdW50KCk7XG4gICAgLy8gTG9hZCB0aGUgc2tldGNoXG4gICAgcmV0dXJuIG1hbmFnZXIubG9hZChza2V0Y2gpLnRoZW4oKCkgPT4ge1xuICAgICAgLy8gU3RhcnQgcGxheWJhY2svcmVuZGVyaW5nXG4gICAgICBtYW5hZ2VyLnJ1bigpO1xuICAgICAgcmV0dXJuIG1hbmFnZXI7XG4gICAgfSk7XG4gIH1cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtYW5hZ2VyKTtcbn1cblxuLy8gVE9ETzogRmlndXJlIG91dCBhIG5pY2Ugd2F5IHRvIGV4cG9ydCB0aGluZ3MuXG4vLyBjYW52YXNTa2V0Y2guY2FudmFzU2tldGNoID0gY2FudmFzU2tldGNoO1xuLy8gY2FudmFzU2tldGNoLlBhcGVyU2l6ZXMgPSBQYXBlclNpemU7XG5cbmV4cG9ydCBkZWZhdWx0IGNhbnZhc1NrZXRjaDtcbiJdLCJuYW1lcyI6WyJjb25zdCIsImxldCIsInRoaXMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUFBLElBQU0sZUFBZTtBQUVyQkEsSUFBTSxPQUFPLENBR1gsQ0FBRSxXQUFZLE1BQU8sT0FDckIsQ0FBRSxlQUFnQixJQUFLLEtBQ3ZCLENBQUUsU0FBVSxJQUFLO0lBQ2pCLENBQUUsZUFBZ0IsSUFBSyxLQUN2QixDQUFFLGdCQUFpQixLQUFNLE1BR3pCLENBQUUsS0FBTSxJQUFLLE1BQ2IsQ0FBRSxLQUFNO0lBQUssS0FDYixDQUFFLEtBQU0sSUFBSyxLQUNiLENBQUUsS0FBTSxJQUFLLEtBQ2IsQ0FBRSxLQUFNLElBQUssS0FDYixDQUFFLEtBQU0sSUFBSyxLQUNiLENBQUUsS0FBTSxJQUFLO0lBQ2IsQ0FBRSxLQUFNLEdBQUksS0FDWixDQUFFLEtBQU0sR0FBSSxJQUNaLENBQUUsS0FBTSxHQUFJLElBQ1osQ0FBRSxNQUFPLEdBQUksSUFD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
